<html>

<head>
<title>IP маршрутизация</title>

<meta http-equiv="Content-type" content="text/html; charset=koi8-r">
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>




<p><a NAME="t090000"></a>Глава 9 IP маршрутизация</p>
<u>

<p><b><a NAME="t091000"></a>Введение</p>
</b></u>

<p><small><a NAME="t091001"></a>Маршрутизация - это одна из
наиболее важных функций IP. На рисунке 9.1 показана
упрощенная модель того, что реализуется на IP
уровене. Датаграммы, которые должны быть
смаршрутизированы, могут генерироваться как
локальным хостом, так и каким-либо удаленным
хостом. В последнем случае наш хост должен быть
сконфигурирован как маршрутизатор, иначе
датаграммы, получаемые через сетевые интерфейсы
и не предназначенные нашему хосту, будут молча
удалены. </small></p>

<p><small>На рисунке 9.1 также показан демон
маршрутизации, который обычно является
пользовательским процессом. Наиболее часто в Unix
системах используются демоны <a NAME="t091002"></a>routed и <a NAME="t091003"></a>gated. Термин <a NAME="t091004"></a>демон (daemon)
означает, что процесс работает &quot;в фоновом
режиме&quot; и его функционирование не оказывает
влияние на систему в целом. Демоны обычно
стартуют, когда система загружается, и живут все
время, пока система работает. Протоколы
маршрутизации, используемые на конкретном хосте,
определяют, как будет происходить обмен
информацией о маршрутах с удаленными
маршрутизаторами. (Заинтересованные читатели
могут обратиться к [<a NAME="t091005"></a>Perlman 1992] для
получения более подробной информации.) Мы
вкратце рассмотрим динамическую маршрутизацию и
протокол обмена информацией о маршрутизации (RIP -
Routing Information Protocol) в <a HREF="tcp10.html">главе 10</a>. В этой
главе мы рассмотрим, как IP уровень принимает
решения о маршрутизации. </small></p>

<p><small>IP уровень обращается к таблице
маршрутизации, которая показана на рисунке 9.1 (на
загруженных хостах подобное обращение может
происходить несколько сот раз в секунду), однако
демон маршрутизации обновляет таблицу
значительно реже (примерно один раз каждые 30
секунд). Таблица маршрутизации также может быть
обновлена, когда принимается ICMP сообщение о
перенаправлении (ICMP redirect), мы увидим это в разделе
<a HREF="#t095000">&quot;ICMP ошибки перенаправления&quot;</a>,
когда будем рассматривать команду <a NAME="t091006"></a>route.
Эта команда обычно исполняется при загрузке
системы и устанавливает некоторые исходные
маршруты. Также в этой главе мы будем
использовать команду <a NAME="t091007"></a>netstat, для
просмотра таблиц маршрутизации.<a NAME="t091008"></a></small></p>


<p ALIGN="CENTER"><small><img SRC="t9_10000.jpg" WIDTH="518" HEIGHT="390"></small></p>


<p ALIGN="CENTER"><small>Рисунок 9.1 Действия, выполняемые IP
уровнем.</small></p>
<u><b>

<p><a NAME="t092000"></a>Принципы маршрутизации</p>
</b></u>

<p><small>Прежде чем начать обсуждение IP
маршрутизации, необходимо понять, что именно
ядро обновляет в таблице маршрутизации.
Информация, содержащаяся в таблице
маршрутизации, необходима IP уровню для принятия
решения о маршрутизации. В разделе <a HREF="tcp03.html#t033000">&quot;IP маршрутизация&quot;</a> главы 3 мы
показали, каким образом IP просматривает свою
таблицу маршрутизации.</small> 

<ol>
  <li><small>Поиск совпадающего адреса хоста.</small></li>
  <li><small>Поиск совпадающего адреса сети.</small></li>
  <li><small>Поиск пункта по умолчанию. (Пункт по
    умолчанию обычно указывается в таблице
    маршрутизации как сеть с идентификатором сети
    равным нулю.)</small></li>
</ol>

<p><small>Совпавший адрес хоста используется всегда
перед совпавшим адресом сети. </small></p>

<p><small>Маршрутизация, осуществляемая IP - процесс
поиска в таблице маршрутизации, определение
интерфейса, куда будет послан пакет, называется <a NAME="t092001"></a>механизмом маршрутизации. С другой
стороны, <a NAME="t092002"></a>политика маршрутизации
устанавливает правила, по которым решается,
какой маршрут будет внесен в таблицу
маршрутизации. IP осуществляет механизм
маршрутизации, тогда как маршрутизирующий демон
обычно определяет политику маршрутизации.</small></p>
<i><b>

<p>Простая таблица маршрутизации</p>
</b></i>

<p><small>Давайте рассмотрим типичные таблицы
маршрутизации. На хосте svr4 мы запустили команду <a NAME="t092003"></a>netstat с опцией <a NAME="t092004"></a>-r, чтобы
просмотреть таблицу маршрутизации, и с опцией -n,
которая печатает IP адреса в цифровом формате, а
не в виде имен. (Мы сделали это, потому что
некоторые пункты таблицы маршрутизации это сети,
а не хосты. Без опции <a NAME="t092005"></a>-n команда <a NAME="t092006"></a>netstat просматривает файл <a NAME="t092007"></a>/etc/networks,
и берет оттуда имена сетей. При этом может
получиться некоторая путаница, потому что в
выводе команды помимо имен хостов появятся имена
сетей.)</small></p>

<p>&nbsp;</p>


<p>svr4 % <b>netstat -rn</b><br>
Routing tables<br>
Destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Gateway
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Flags
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Refcnt&nbsp; Use&nbsp;&nbsp;&nbsp;&nbsp; Interface<br>
140.252.13.65&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 140.252.13.35&nbsp;&nbsp;&nbsp;&nbsp; UGH
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emd0<br>
127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 127.0.0.1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UH
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lo0<br>
default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 140.252.13.33
&nbsp;&nbsp;&nbsp;&nbsp; UG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emd0<br>
140.252.13.32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 140.252.13.34&nbsp;&nbsp;&nbsp;&nbsp; U
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 25043&nbsp;&nbsp; emd0<br>
</p>


<p>&nbsp;</p>

<p><small>В первой строке говорится, что для пункта
назначения 140.252.13.65 (хост slip) шлюз (маршрутизатор),
на который будут посылаться пакеты, это 140.252.13.35
(bsdi). Хост slip подсоединен к bsdi через SLIP канал, а bsdi
находится в той же сети Ethernet, что и данный хост. </small></p>

<p><small>Для конкретного маршрута может быть
показано 5 различных флагов.</small></p>

<p><small>&nbsp;</small> 

<dl>
  <p><small>U</small></p>
  <dd><small>Маршрут активен.</small></dd>
  <p><small>G</small></p>
  <dd><small>Маршрут подключен к шлюзу (маршрутизатору).
    Если этот флаг не установлен, считается, что
    пункт назначения подключен непосредственно.</small></dd>
  <p><small>H</small></p>
  <dd><small>Маршрут ведет к хосту, что означает, что в
    качестве пункта назначения используется полный
    адрес хоста. Если этот флаг не установлен, то
    маршрут указывает на сеть, что в свою очередь
    означает, что пунктом назначения является адрес
    сети: идентификатор сети или комбинация
    идентификатора сети и идентификатора подсети.</small></dd>
  <p><small>D</small></p>
  <dd><small>Маршрут был создан посредством
    перенаправления (<a HREF="#t095000">&quot;ICMP ошибки
    перенаправления&quot;</a>).</small></dd>
  <p><small>M</small></p>
  <dd><small>Маршрут был модифицирован посредством
    перенаправления (<a HREF="#t095000">&quot;ICMP ошибки
    перенаправления&quot;</a>).</small></dd>
</dl>

<p>&nbsp;</p>

<p><small>Флаг G очень важен, потому что именно этот
флаг определяет различие между <a NAME="t092008"></a>непрямым
маршрутом (indirect route) и <a NAME="t092009"></a>прямым
маршрутом (direct route). (Флаг G не устанавливается для
прямого маршрута.) Отличие заключается в том, что
у пакета, направляющегося по прямому маршруту, IP
адрес и адрес канального уровня указывают на
конечный пункт назначения (рисунок 3.3). Когда
пакет отправляется по непрямому маршруту, IP
адрес указывает на конечный пункт назначения, а
адрес канального уровня указывает на <a NAME="t092010"></a>маршрутизатор
следующей пересылки. Мы видели подобный пример
этого на рисунке 3.4. В этой таблице маршрутизации
мы видим непрямой маршрут (флаг G установлен), при
этом IP адрес пакета, который будет передаваться
по этому маршруту, будет совпадать с IP адресом
конечного пункта назначения (140.252.13.65), а адрес
канального уровня будет указывать на
соответствующий маршрутизатор, IP адрес которого
140.252.13.35. </small></p>

<p><small>Очень важно понимать разницу между флагами
G и H. Флаг G определяет различие между прямым и
непрямым маршрутом, как описано выше. Флаг H
указывает на то, что адрес пункта назначения
(первая колонка вывода команды netstat) это полный
адрес хоста. Отсутствие флага H означает, что
адрес назначения это адрес сети (идентификатор
хоста должен быть установлен в 0). При просмотре
таблицы маршрутизации используются следующие
правила: если маршрут указывает на хост он должен
полностью совпадать с IP адресом пункта
назначения, если маршрут указывает на сеть -
сопасть должны идентификаторы сети и любого
идентификатора подсети в адресе пункта
назначения. Большинство версий команды netstat
сначала печатают все пункты, указывающие на
хосты, после чего печатаются пункты, указывающие
на сети. </small></p>

<p><small>Колонка счетчика обращений (reference count)
сообщает о количестве использований каждого
маршрута. Протоколы, ориентированные на
соединения, такие как TCP, занимают маршрут все
время, пока соединение установлено. Если
установить Telnet соединение между хостами svr4 и slip,
то счетчик обращений будет установлен в 1. Если
установить еще одно Telnet соединение, счетчик
будет показывать 2, и так далее. </small></p>

<p><small>Следующая колонка (use) показывает
количество пакетов, прошедших по этому маршруту.
Если запустить программу <a NAME="t092011"></a>ping, которая
отправит 5 пакетов, счетчик установится в
значение 5 (Естественно, при условии, что никто
больше не использует этот маршрут). Последняя
колонка интерфейс (interface) сообщает нам имя
локального интерфейса. </small></p>

<p><small>Вторая строка в выводе относится к <a NAME="t092012"></a>loopback интерфейсу (глава 2, раздел <a HREF="tcp02.html#t027000">&quot;Интерфейс Loopback&quot;</a>), который
всегда имеет имя lo0. Флаг G не установлен, так как
маршрут не ведет к маршрутизатору. Флаг H
указывает, что адрес назначения (127.0.0.1) это адрес
хоста, а не адрес сети. Когда флаг G не установлен,
это указывает на прямой маршрут, в колонке gateway
указывается IP адрес исходящего интерфейса. </small></p>

<p><small>Третья строка вывода описывает маршрут по
умолчанию. Каждый хост должен иметь один или
несколько маршрутов по умолчанию. Этот пункт
указывает на то, что необходимо посылать пакеты
на маршрутизатор 140.252.13.33 (sun), если не был найден
конкретный маршрут. Это означает, что хост svr4
может получить доступ к другим системам в Internet
через маршрутизатор sun (и его SLIP канал)
воспользовавшись этим единственным пунктом
таблицы маршрутизации. Возможность установить
маршрут по умолчанию это одна из наиболее мощных
концепций IP маршрутизации. Флаги для этого
маршрута (UG) говорят о том, что маршрут указывает
на маршрутизатор.</small></p>

<p>&nbsp;</p>


<p>Здесь мы специально
назвали sun маршрутизатором, а не хостом, потому
что когда он работает как маршрутизатор по
умолчанию, используются его функции IP
перенаправления, при этом он не выступает в роли
хоста.</p>

<p>Требования к хостам <a NAME="t092013"></a>Host
Requirements RFC указывает, что IP уровень должен
поддерживать несколько маршрутов по умолчанию.
Большинство реализаций, однако, этого не
позволяют. Когда существует несколько маршрутов
по умолчанию, общая техника выбора маршрута
заключается в последовательном многократном
переборе маршрутов. Именно так поступает,
например, <a NAME="t092014"></a>Solaris 2.2.</p>


<p>&nbsp;</p>

<p><small>И последняя строка указывает на
подключенный Ethernet. Флаг H не установлен, это
указывает на то, что адрес назначения (140.252.13.32)
это адрес сети, при этом идентификатор хоста
установлен в 0. И действительно, 5 младших битов
установлены в 0 (рисунок 3.11). Это прямой маршрут
(флаг G не установлен), поэтому в колонке gateway
указывается IP адрес исходящего интерфейса. </small></p>

<p><small>Существует еще один немаловажный аспект,
оказывающий влияние на маршрутизацию, однако он
не отражен в выводе команды <a NAME="t092015"></a>netstat. Это
маска подсети, связанная с адресом назначения
(140.252.13.32). Когда адрес пункта назначения
сравнивается с IP адресом 140.252.13.33, адрес перед
сравнением, логически суммируется с маской
подсети, связанной с этим адресом назначения
(0xffffffe0 из раздела <a HREF="tcp03.html#t037000">&quot;Пример
подсети&quot;</a> главы 3). Так как ядро знает каждый
интерфейс, связанный с каждым пунктом таблицы
маршрутизации, и так как каждый интерфейс имеет
маску подсети, каждый пункт таблицы
маршрутизации имеет собственную маску подсети.</small></p>

<p><small>Сложность таблицы маршрутизации хоста
зависит от топологии сетей, к которым хост имеет
доступ.</small> 

<ol>
  <li><small>Самый простой (однако наименее интересный)
    случай - это когда хост вообще не подключен к
    сетям. Протоколы TCP/IP могут использоваться на
    этом хосте, однако только для общения с самим
    собой! Таблица маршрутизации в данном случае
    содержит единственный пункт соответствующий
    loopbackv интерфейсу.</small></li>
  <li><small>Хост подключен к одной локальной сети и
    имеет возможность получить доступ к хостам
    только в этой локальной сети. Таблица
    маршрутизации имеет 2 пункта: один для <a NAME="t092016"></a>loopback
    интерфейса и один для локальной сети (например,
    Ethernet).</small></li>
  <li><small>Возможен вариант, когда другие сети
    (например, Internet) доступны через один
    маршрутизатор. В этом случае обычно используется
    пункт по умолчанию, указывающий на этот
    маршрутизатор.</small></li>
  <li><small>И последнее, когда добавляются маршруты к
    хостам или сетям. Примером этого может служить
    маршрут к хосту slip через маршрутизатор bsdi.</small></li>
</ol>

<p><small>Давайте проследим за тем, что делает IP когда
обращается к таблице маршрутизации, чтобы
смаршрутизировать пакеты на хосте svr4. </small></p>

<p><small>&nbsp;</small> 

<ol>
  <li><small>Предположим, что адрес назначения
    принадлежит хосту sun, 140.252.13.33. Во-первых,
    осуществляется поиск совпадающего адреса хоста.
    Два пункта хостов в таблице (slip и localhost) не
    совпадают, поэтому поиск в таблице маршрутизации
    осуществляется снова на предмет совпадающего
    адреса сети. Совпадение найдено в пункте 140.252.13.32
    (идентификатор сети и идентификатор подсети
    совпали), поэтому используется интерфейс emd0. Это
    прямой маршрут, поэтому адрес канального уровня
    будет являться адресом назначения.</small></li>
  <li><small>Предположим, что адрес назначения это адрес
    хоста slip, 140.252.13.65. Первый поиск в таблице
    маршрутизации на предмет совпадающего адреса
    хоста заканчивается успешно. Это непрямой
    маршрут, поэтому IP адрес назначения остается
    140.252.13.65, а адресом канального уровня будет адрес
    канального уровня маршрутизатора 140.252.13.35,
    используется интерфейс emd0.</small></li>
  <li><small>Теперь мы посылаем датаграмму по Internet на
    хост aw.com (192.207.117.2). Первый поиск в таблице
    маршрутизации на предмет совпадающего адреса
    хоста заканчивается неудачей, поэтому
    осуществляется поиск на предмет совпадающего
    адреса сети. Он также завершается неудачно. И
    последний шаг это поиск пункта по умолчанию,
    который заканчивается успешно. Маршрут является
    непрямым через маршрутизатор 140.252.13.33 с
    использованием интерфейса emd0.</small></li>
  <li><small>В нашем последнем примере мы послали
    датаграмму на свой собственный хост. Существует 4
    способа сделать это, используя имя хоста, IP адрес
    хоста, loopback имя или loopback IP адрес:</small><p>ftp svr4<br>
    ftp 140.252.13.34<br>
    <br>
    ftp localhost<br>
    ftp 127.0.0.1</p>
    <p>&nbsp;</p>
    <p><small>В двух первых случаях второй поиск в
    таблице маршрутизации приведет к совпадению с
    сетью 140.252.13.32, и пакет посылается через Ethernet
    драйвер. Как мы показали на рисунке 2.4, пакет,
    предназначенный на собственный IP адрес хоста,
    посылается в loopback драйвер, который ставит пакет
    во входную очередь IP.</small></p>
    <p><small>В двух следующих случаях указано имя loopback
    интерфейса или его IP адрес, поэтому первый поиск
    в таблице маршрутизации приведет к совпадению
    адреса хоста, и пакет отсылается в loopback драйвер,
    который ставит его во входную очередь IP.</small></p>
    <p><small>Во всех четырех случаях пакет отправляется
    в loopback драйвер, однако принимаются два разных
    решения о маршрутизации.</small></p>
  </li>
</ol>

<p>&nbsp;</p>
<i><b>

<p>Инициализация таблицы маршрутизации</p>
</b></i>

<p><small>Мы никогда не упоминали о том, как создаются
пункты в таблице маршрутизации. Когда
инициализируется интерфейс (обычно, когда адрес
интерфейса устанавливается командой <a NAME="t092017"></a>ifconfig),
автоматически создается прямой маршрут для
этого интерфейса. Для каналов точка-точка и <a NAME="t092018"></a>loopback интерфейса устанавливается
маршрут к хосту (то есть устанавливается флаг H).
Для широковещательных интерфейсов, таких как
Ethernet, маршрутом является сама эта сеть. </small></p>

<p><small>Маршруты к хостам или сетям, которые не
подключены непосредственно, должны быть
помещены в таблицу маршрутизации каким-либо иным
образом. Самый распространенный способ создания
маршрутов - с помощью команды <a NAME="t092019"></a>route, что
обычно делается из загрузочных файлов при старте
системы. На хосте svr4 были исполнены следующие
команды, которые добавляют пункты, показанные
ранее:</small></p>

<p>&nbsp;</p>


<p>route add default sun 1<br>
route add slip bsdi 1</p>


<p>&nbsp;</p>

<p><small>Третий аргумент (default и slip) это пункты
назначения, четвертый аргумент это
маршрутизатор (gateway) и последний аргумент это
показатель маршрутизации. Команда route использует
показатель маршрутизации следующим образом: она
устанавливает флаг G, если показатель больше чем
0, и не устанавливает флаг G, если показатель равен
0.</small></p>

<p>&nbsp;</p>


<p>К сожалению, совсем
немногие системы содержат команды route в своих
стартовых файлах. В <a NAME="t092020"></a>4.4BSD и <a NAME="t092021"></a>BSD/386
это <a NAME="t092022"></a>/etc/netstat, в <a NAME="t092023"></a>SVR4 - <a NAME="t092024"></a>/etc/inet/rc.inet, в <a NAME="t092025"></a>Solaris 2.x - <a NAME="t092026"></a>/etc/rc2.d/S69inet, в <a NAME="t092027"></a>SunOS 4.1.x - <a NAME="t092028"></a>/etc/rc.local и в <a NAME="t092029"></a>AIX 3.2.2 - <a NAME="t092030"></a>/etc/rc.net.</p>


<p>&nbsp;</p>

<p><small>В некоторых системах маршрутизатор по
умолчанию содержится в файле, например, <a NAME="t092031"></a>/etc/defaultrouter.
Этот пункт по умолчанию добавляется в таблицу
маршрутизации при каждой перезагрузке. </small></p>

<p><small>Существует еще один способ заполнить
таблицу маршрутизации с помощью запуска демона
маршрутизации (см. <a HREF="tcp10.html">главу 10</a>) или с
помощью нового протокола определения маршрутов
(раздел <a HREF="#t096000">&quot;ICMP сообщения поиска
маршрутизатора&quot;</a>).</small></p>
<i><b>

<p>Более сложные таблицы маршрутизации</p>
</b></i>

<p><small>Хост sun является маршрутизатором по
умолчанию для всех хостов в нашей подсети, так
как он имеет SLIP канал с дозвоном, который
подключен к Internet (см. рисунок на внутренней
стороне обложки).</small></p>

<p>&nbsp;</p>


<p>sun % <b>netstat -rn</b><br>
Routing tables<br>
Destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Gateway
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Flags
&nbsp;&nbsp;&nbsp; Refcnt&nbsp; Use&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Interface<br>
140.252.13.65&nbsp;&nbsp;&nbsp; 140.252.13.35&nbsp;&nbsp;&nbsp;&nbsp; UGH
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 171
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; le0<br>
127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 127.0.0.1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 766&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lo0<br>
140.252.1.183&nbsp;&nbsp;&nbsp; 140.252.1.29&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UH
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sl0<br>
default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 140.252.1.183
&nbsp;&nbsp;&nbsp;&nbsp; UG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2955&nbsp;&nbsp;&nbsp;&nbsp; sl0<br>
140.252.13.32&nbsp;&nbsp;&nbsp; 140.252.13.33&nbsp;&nbsp;&nbsp;&nbsp; U
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 99551
&nbsp;&nbsp;&nbsp; le0<br>
</p>


<p>&nbsp;</p>

<p><small>Первые два пункта таблицы маршрутизации sun
идентичны первым двум пунктам для хоста svr4:
маршрут, указывающий на хост slip, через
маршрутизатор bsdi и loopback маршрут. </small></p>

<p><small>Третья строка отличается. Это прямой
маршрут (флаг G не установлен) на хост (флаг H
установлен), соответствующий каналу точка-точка,
интерфейс SLIP. Если мы посмотрим на вывод команды
ifconfig,</small></p>

<p>&nbsp;</p>


<p>sun % <b>ifconfig sl0</b><br>
sl0: flags=1051&lt;UP, POINTOPOINT, RUNNING&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inet 140.252.1.29 --&gt; 140.252.1.183 netmask
ffffff00<br>
</p>


<p>&nbsp;</p>

<p><small>то увидим, что адрес назначения в таблице
маршрутизации на другом конце канала точка-точка
(маршрутизатор netb), а адрес маршрутизатора в
действительности это локальный IP адрес
исходящего интерфейса (140.252.1.29). (Раньше мы
говорили, что для прямых маршрутов адрес
маршрутизатора печатается командой netstat как
локальный IP адрес используемого интерфейса.) </small></p>

<p><small>Пункт по умолчанию это непрямой маршрут
(флаг G), указывающий на сеть (нет флага H). Адрес
маршрутизатора - 140.252.1.183, (адрес на другом конце
SLIP канала), а не локальный IP адрес SLIP интерфейса
(140.252.1.29) (так как это непрямой маршрут). </small></p>

<p><small>Необходимо обратить внимание на то, что
третья и четвертая строки в выводе команды <a NAME="t092032"></a>netstat (интерфейс sl0) создаются
программным обеспечением SLIP при установлении
канала SLIP, они удаляются, когда канал SLIP
отключается.</small></p>
<i><b>

<p>Нет маршрута к пункту назначения</p>
</b></i>

<p><small>Во всех наших примерах сделано
предположение, что поиск в таблице маршрутизации
заканчивается успешно и будет обнаружено
соответствие, хотя бы с маршрутором по умолчанию.
Что произойдет, если маршрут по умолчанию
отсутствует, и не будет найдено совпадение с
указанным пунктом назначения? </small></p>

<p><small>Ответ зависит от того, какого рода IP
датаграмма обрабатывается, то есть была ли она
сгенерирована непосредственно этим хостом или
она должна быть перенаправлена (в том случае,
если хост выступает в роли маршрутизатора). Если
датаграмма была сгенерирована этим хостом,
приложению, которое отправило датаграмму,
возвращается ошибка <a NAME="t092033"></a>&quot;хост
недоступен&quot; (host unreachable) или <a NAME="t092034"></a>&quot;сеть
недоступна&quot; (network unreachable). Если датаграмма
должна быть перенаправлена, посылающему хосту
возвращается ICMP собщение о недоступности хоста.
Мы рассмотрим эту ошибку в следующем разделе.</small></p>
<u><b>

<p><a NAME="t093000"></a>ICMP ошибки о недоступности хоста и
сети</p>
</b></u>

<p><small>ICMP ошибка о недоступности хоста (host unreachable)
отправляется маршрутизатором, когда он получает
IP датаграмму, которую невозможно перенаправить.
(На рисунке 6.10 мы показали формат ICMP сообщений о
недоступности.) Мы сможем пронаблюдать это в
нашей сети, если выключим SLIP канал с дозвоном на
маршрутизаторе sun и попробуем отправить пакет
через SLIP канал с любого другого хоста, указав sun
как маршрутизатор по умолчанию.</small></p>

<p>&nbsp;</p>


<p>Ранние реализации TCP/IP в
BSD генерировали и ошибки о недоступности хоста, и
ошибки о недоступности сети, в зависимости от
того, принадлежал ли пункт назначения локальной
подсети или нет. <a NAME="t093004"></a>4.4BSD генерирует
только ошибку о недоступности хоста.</p>


<p>&nbsp;</p>

<p><small>Обратимся снова к выводу команды netstat
запущенной на маршрутизаторе sun, вывод показан в
предыдущем разделе. Мы видим, что пункт таблицы
маршрутизации, который соответствует SLIP каналу,
добавляется, когда SLIP канал включается, и
удаляется, когда SLIP канал выключается. Это
означает, что когда SLIP канал отключен, маршрута
по умолчанию на sun не существует. Однако мы не
будем пытаться изменить все таблицы
маршрутизации у хостов в нашей маленькой сети,
оставив им возможность самим удалить свои
маршруты по умолчанию. Вместо этого мы посчитаем
ICMP сообщения о недоступности хоста,
сгенерированные sun для любых пакетов, которые он
не может перенаправить.</small></p>

<p><small>Мы можем увидеть это, запустив <a NAME="t093002"></a>ping
с svr4 на хост, находящийся на другом конце SLIP
канала (в настоящее время этот хост выключен):</small></p>

<p>&nbsp;</p>


<p>svr4 % <b>ping gemini</b><br>
ICMP Host Unreachable from gateway sun (140.252.13.33)<br>
ICMP Host Unreachable from gateway sun (140.252.13.33)<br>
^<b>?</b>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; символ
прерывания<br>
</p>


<p>&nbsp;</p>

<p><small>На рисунке 9.2 мы показали вывод команды <a NAME="t093003"></a>tcpdump для этого примера. (Команда
запущена на хосте bsdi).<a NAME="t093001"></a></small></p>

<p>&nbsp;</p>


<p>1 0.0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt;
gemini: icmp: echo request<br>
2 0.00 (0.00)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sun &gt; svr4: icmp: host gemini unreachable<br>
<br>
3 0.99 (0.99)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; gemini: icmp: echo request<br>
4 0.99 (0.00)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sun &gt; svr4: icmp: host gemini unreachable<br>
</p>


<p>&nbsp;</p>

<p><small>Рисунок 9.2 Сообщение ICMP о недоступности
хоста в ответ на ping.</small></p>

<p>&nbsp;</p>

<p><small>Когда маршрутизатор sun обнаруживает, что на
хост gemini нет маршрута, он отвечает на эхо запрос
сообщением о недоступности хоста. </small></p>

<p><small>Если мы включим SLIP канал, подключающий нас к
Internet, и попробуем послать ping на несуществующий в
Internet IP адрес, то рано или поздно получим
сообщение об ошибке. Интересно посмотреть, как
далеко уйдет пакет по Internet, перед тем как будет
получена ошибка:</small></p>

<p>&nbsp;</p>


<p>sun % <b>ping 192.82.148.1 </b>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; этот IP
адрес не подключен к Internet<br>
PING 192.82.148.1: 56 data bytes<br>
ICMP Host Unreachable from gateway enss142.UT.westnet.net (192.31.39.21)<br>
&nbsp; for icmp from sun (140.252.1.29) to 192.82.148.1<br>
</p>


<p>&nbsp;</p>

<p><small>Обратившись к рисунку 8.5, мы увидим, что
пакет прошел через шесть маршрутизаторов, перед
тем как было определено, что IP адрес не
существует. Только когда он дошел до пределов NSFNET
магистрали, была выявлена ошибка. Это произошло
из-за того, что шесть маршрутизаторов, которые
перенаправляли пакет, отправляли его на пункт
назначения по умолчанию. И только когда пакет
достиг NSFNET магистрали, маршрутизатор, имеющий
полное представление о каждой сети, подключенной
к Internet, смог определить ошибку. Это иллюстрирует
тот факт, что большинство маршрутизаторов
функционируют, не представляя себе полной
топологии сетей. </small></p>

<p><small><a NAME="t093005"></a>[Ford, Rekhter, and Braun 1993] определяет <a NAME="t093006"></a>домены маршрутизации верхнего уровня
(top-level routing domain) как маршрутизаторы,
поддерживающие и обрабатывающие информацию о
большинстве узлов Internet и не использующие
маршрутов по умолчанию. В Internet существует пять
доменов маршрутизации верхнего уровня: <a NAME="t093007"></a>NFSNET
магистраль, <a NAME="t093008"></a>Commercial Internet Exchange (CIX), <a NAME="t093009"></a>NASA Science Internet (NSI), <a NAME="t093010"></a>SprintLink и <a NAME="t093011"></a>European IP Backbone (EBONE).</small></p>
<u><b>

<p><a NAME="t094000"></a>Перенаправлять или не
перенаправлять</p>
</b></u>

<p><small><a NAME="t094001"></a>Мы уже несколько раз упоминали
о том, что хост не сможет перенаправить IP
датаграммы, если он специально не
сконфигурирован, чтобы выступать в роли
маршрутизатора. Как осуществляется подобная
конфигурация? </small></p>

<p><small>Большинство Berkeley реализаций, имеют
переменную ядра, названную <a NAME="t094002"></a>ipforwarding
(или похоже). (См. <a HREF="tcp_e.html">приложение Е</a>.)
Некоторые системы (<a NAME="t094003"></a>BSD/386 и <a NAME="t094004"></a>SVR4,
например) перенаправляют датаграммы, если эта
переменная установлена в ненулевое значение. В <a NAME="t094005"></a>SunOS&nbsp;4.1.x определено три значения для
этой переменной: -1 обозначает, что
перенаправление никогда не будет осуществляться
и что никогда нельзя будет сменить значение этой
переменной, 0 обозначает, что перенаправление не
осуществляется, однако значение переменной
устанавливается в 1, когда два или более
интерфейсов активизированы, и 1 обозначает, что
перенаправление осуществляется всегда. У <a NAME="t094006"></a>Solaris 2.x также существует три значения, а
именно 0 (перенаправление не осуществляется), 1
(перенаправление осуществляется всегда) и 2
(перенаправление осуществляется только тогда,
когда активизированы два или более интерфейсов). </small></p>

<p><small>В более ранних реализациях <a NAME="t094007"></a>4.2BSD
датаграммы перенаправляются по умолчанию. При
этом, если система сконфигурирована неверно,
возникает очень много проблем. Именно поэтому
данная опция ядра должна быть всегда по
умолчанию установлена в значение &quot;без
перенаправления&quot; (never forward), пока системный
администратор специально не включит
перенаправление.</small></p>
<u><b>

<p><a NAME="t095000"></a>ICMP ошибки перенаправления</p>
</b></u>

<p><small>ICMP ошибка перенаправления отправляется
маршрутизатором на хост, пославший IP датаграмму,
когда датаграмма должна быть послана на другой
маршрутизатор. Подобная концепция довольно
проста. Мы привели три составные части этой
концепции на рисунке 9.3. Увидеть <a NAME="t095001"></a>ICMP
перенаправление можно только когда хост имеет
выбор, на какой маршрутизатор послать пакет.
(Обратитесь к примерам, которые мы приводили на
рисунке 7.6.)</small> 

<ol>
  <li><small>Предположим, что хост посылает IP датаграмму
    на R1. Подобное решение принято потому, что R1 - это
    маршрутизатор по умолчанию для этого хоста.</small></li>
  <li><small>R1 принимает датаграмму, просматривает свою
    таблицу маршрутизации, и определяет, что <a NAME="t095002"></a>маршрутизатором следующей пересылки
    является R2, и именно туда необходимо отправить
    датаграмму. Когда R1 отправляет датаграмму на R2,
    он определяет, что отправляет ее на тот же самый
    интерфейс, с которого датаграмма была получена
    (локальная сеть, к которой подключен хост и два
    маршрутизатора). В этом случае маршрутизатор
    отправляет ошибку перенаправления на хост,
    пославший датаграмму.</small></li>
  <li><small>R1 посылает ICMP перенаправление на хост,
    сообщая тем самым, что следующие датаграммы
    необходимо посылать на R2 вместо R1.<a NAME="t095003"></a></small></li>
</ol>


<p ALIGN="CENTER"><small><img SRC="t9_30000.jpg" WIDTH="394" HEIGHT="227"></small></p>


<p ALIGN="CENTER"><small>Рисунок 9.3 Пример ICMP
перенаправления.</small></p>

<p>&nbsp;</p>

<p><small>Перенаправления используются для того,
чтобы позволить хосту с минимальным знанием о
маршрутах поддерживать и обновлять свою таблицу
маршрутизации. Как правило, формирование таблицы
маршрутизации хоста начинается с создания
маршрута по умолчанию (R1 или R2 из нашего примера
на рисунке 9.3), при этом с использованием
перенаправления хост может обновить свою
таблицу маршрутизации. ICMP перенаправление
позволяет TCP/IP хостам полностью полагаться на
интеллектуальность маршрутизаторов в вопросе
выбора маршрутов. Маршрутизаторы R1 и R2 в нашем
примере должны точно представлять топологию
подключенных сетей, тогда как хосты,
подключенные к локальной сети, могут начинать
свою маршрутизацию с маршрута по умолчанию,
узнавая затем более подробно о новых маршрутах
из принятых перенаправлений.</small></p>
<i><b>

<p>Пример</p>
</b></i>

<p><small>Посмотрим ICMP перенаправления в действии на
примере нашей сети (на внутренней стороне
обложки). Мы показали всего три хоста (aix, solaris и
gemini) и два маршрутизатора (gateway и netb) в верхней
части сети, в действительности там более 150
хостов и 10 маршрутизаторов. Большинство хостов
считают gateway маршрутизатором по умолчанию, так
как он предоставляет доступ к Internet. </small></p>

<p><small>Как можно получить доступ из подсети 140.252.1 к
нижней подсети (4 нижние хоста на рисунке)?
Во-первых, вспомним, что если на конце SLIP канала
находится единственный хост, используется <a NAME="t095004"></a>уполномоченный агент ARP (глава 4, раздел
<a HREF="tcp04.html#t046000">&quot;Уполномоченный агент ARP&quot;</a>).
Это означает, что для хостов в верхней сети 140.252.1
не требуется специальных средств, для того чтобы
получить доступ к хосту sun (140.252.1.29). Доступ
обеспечит программное обеспечение
уполномоченного агента ARP на netb. </small></p>

<p><small>Однако, если на удаленном конце SLIP канала
присутствует сеть, то необходима маршрутизация.
Одно из возможных решений заключается в том,
чтобы каждый хост и маршрутизатор знали о том,
что маршрутизатор netb является шлюзом в сеть
140.252.13. Этого можно добиться путем внесения
статического маршрута в каждую таблицу
маршрутизации на каждом хосте или запустив на
каждом хосте маршрутизирующий демон. Однако
существует более простой способ (метод, который
обычно используется) - использовать ICMP
перенаправление. </small></p>

<p><small>Запустим программу ping с хоста solaris в верхней
сети на хост bsdi (140.252.13.35) в нижней сети. Так как
идентификаторы подсети различны, уполномоченный
агент ARP не может быть использован. Предположим,
что статический маршрут не установлен, поэтому
при посылке первого пакета будет использован
маршрут по умолчанию на маршрутизатор gateway. Ниже
мы приводим таблицу маршрутизации, перед тем как
запустили ping:</small></p>

<p>&nbsp;</p>


<p>solaris % <b>netstat -rn</b><br>
Routing Table:<br>
Destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Gateway
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Flags&nbsp; Ref&nbsp;&nbsp; Use
&nbsp;&nbsp;&nbsp;&nbsp; Interface<br>
-------------- --------------- ------- --- ------- --------------<br>
127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 127.0.0.1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp;&nbsp;&nbsp;&nbsp; 848&nbsp; lo0<br>
140.252.1.0&nbsp;&nbsp;&nbsp; 140.252.1.32&nbsp;&nbsp;&nbsp;&nbsp; U
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp; 15042&nbsp; le0<br>
224.0.0.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 140.252.1.32&nbsp;&nbsp;&nbsp;&nbsp; U
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp; le0<br>
default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 140.252.1.4
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp;&nbsp;&nbsp; 5747<br>
</p>


<p>&nbsp;</p>

<p><small>(Пункт 224.0.0.0 используется для групповой
адресации IP. Мы опишем это в <a HREF="tcp12.html">главе 12</a>.)
Если указать опцию <a NAME="t095005"></a>-v в командной
строке <a NAME="t095006"></a>ping, то будут видны все ICMP
сообщения принятые хостом. Нам необходимо
указать эту опцию, чтобы увидеть сообщения о
перенаправлении, которые будут посланы.</small></p>

<p>&nbsp;</p>


<p>solaris % <b>ping -sv bsdi</b><br>
PING bsdi: 56 data bytes<br>
ICMP Host redirect from gateway gateway (140.252.1.4)<br>
to netb (140.252.1.183) for bsdi (140.252.13.35)<br>
64 bytes from bsdi (140.252.13.35): icmp_seq=0. time=383. ms<br>
64 bytes from bsdi (140.252.13.35): icmp_seq=1. time=364. ms<br>
64 bytes from bsdi (140.252.13.35): icmp_seq=2. time=353. ms<br>
^<b>?</b>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; символ
прерывания<br>
----bsdi PING Statistics----<br>
4 packets transmitted, 3 packets received, 25% packet loss<br>
round-trip (ms) min/avg/max = 353/366/383<br>
</p>


<p>&nbsp;</p>

<p><small>Перед тем как мы получим первый ответ на ping,
хост примет ICMP перенаправление от
маршрутизатора по умолчанию gateway. Если мы затем
посмотрим таблицу маршрутизации, то увидим, что
появился новый маршрут к хосту bsdi. (Этот пункт
выделен жирным шрифтом.)</small></p>

<p>&nbsp;</p>


<p>solaris % <b>netstat -rn</b><br>
Routing Table:<br>
&nbsp; Destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Gateway
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Flags&nbsp; Ref&nbsp;&nbsp; Use
&nbsp;&nbsp;&nbsp;&nbsp; Interface<br>
--------------- --------------- -------- --- ------- -------------<br>
127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 127.0.0.1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp;&nbsp;&nbsp;&nbsp; 848&nbsp; lo0<br>
<b>140.252.13.35&nbsp;&nbsp; 140.252.1.183&nbsp;&nbsp;&nbsp;&nbsp; UGHD
&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2</b><br>
140.252.1.0&nbsp;&nbsp;&nbsp;&nbsp; 140.252.1.32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp; 15045&nbsp; le0<br>
224.0.0.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 140.252.1.32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp; le0<br>
default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 140.252.1.4
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0
&nbsp;&nbsp;&nbsp; 5749<br>
</p>


<p>&nbsp;</p>

<p><small>Pltcmm мы впервые видиv флаг D, который
означает, что маршрут был установлен с
использованием ICMP перенаправления. Флаг G
обозначает, что это непрямой маршрут к шлюзу (netb),
а флаг H обозначает, что это маршрут к хосту (как
мы и ожидали), а не маршрут к сети. </small></p>

<p><small>Так как это маршрут к хосту, добавленный
путем перенаправления, он обслуживает только
хост bsdi. Если затем мы попробуем получить доступ
к хосту svr4, будет сгенерировано еще одно
перенаправление, и будет создан еще один маршрут
к хосту. Точно так же, попытка получить доступ к
хосту slip создаст еще один маршрут. Каждое
перенаправление на конкретный хост приводит к
созданию нового маршрута к хосту. Все три хоста в
подсети (bsdi, svr4 и slip) будут обслуживаться одним
маршрутом к сети, указывающим на маршрутизатор
sun. Однако, ICMP перенаправления создают маршруты к
хостам, а не маршруты к сетям, так как
маршрутизатор, генерирующий перенаправление в
данном примере (gateway), не имеет представления о
структуре подсетей в сети 140.252.13.</small></p>
<i><b>

<p>Более подробно</p>
</b></i>

<p><small>На рисунке 9.4 показан формат сообщения ICMP о
перенаправлении.<a NAME="t095007"></a>&nbsp;</small></p>


<p ALIGN="CENTER"><small><img SRC="t9_40000.jpg" WIDTH="511" HEIGHT="168"></small></p>


<p ALIGN="CENTER"><small>Рисунок 9.4 ICMP сообщение о
перенаправлении.</small></p>

<p>&nbsp;</p>

<p><small>Существуют четыре различных типа сообщений
о перенаправлении, с различными значениями кода
(code), как показано на рисунке 9.5.<a NAME="t095008"></a></small></p>

<p>&nbsp;</p>


<table BORDER="1" CELLSPACING="1" BORDERCOLOR="#000000" CELLPADDING="5" WIDTH="557">
  <tr>
    <td WIDTH="12%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>код</small></td>
    <td WIDTH="88%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>Описание</small></td>
  </tr>
  <tr>
    <td WIDTH="12%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="88%" VALIGN="TOP"><small>перенаправление
    для сети</small></td>
  </tr>
  <tr>
    <td WIDTH="12%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="88%" VALIGN="TOP"><small>перенаправление
    для хоста</small></td>
  </tr>
  <tr>
    <td WIDTH="12%" VALIGN="TOP"><p ALIGN="CENTER"><small>2</small></td>
    <td WIDTH="88%" VALIGN="TOP"><small>перенаправление
    для типа сервиса (TOS) и сети</small></td>
  </tr>
  <tr>
    <td WIDTH="12%" VALIGN="TOP"><p ALIGN="CENTER"><small>3</small></td>
    <td WIDTH="88%" VALIGN="TOP"><small>перенаправление
    для типа сервиса (TOS) и хоста</small></td>
  </tr>
</table>


<p><small>Рисунок 9.5 Различные значения code для ICMP
перенаправления. </small></p>

<p>&nbsp;</p>

<p><small>Существуют три IP адреса, которые должен
знать получатель ICMP перенаправления: (1) IP адрес,
который вызвал перенаправление (находится в IP
заголовке, возвращенном как данные в ICMP
сообщении о перенаправлении), (2) IP адрес
маршрутизатора, который послал перенаправление
(является IP адресом источника IP датаграммы,
содержащей перенаправление) и (3) IP адрес
маршрутизатора, который должен быть использован
(находится в байтах с 4-го по 7-ой в ICMP сообщении). </small></p>

<p><small>Существует несколько правил, посвященных
ICMP перенаправлениям. Во-первых, перенаправления
генерируются только маршрутизаторами, ни в коем
случае не хостами. Однако, перенаправления могут
быть использованы только хостами, не
маршрутизаторами. Считается, что маршрутизаторы
используют протоколы маршрутизации и
обмениваются таблицами с другими
маршрутизаторами, поэтому они не нуждаются в
перенаправлениях. (Это означает, что на рисунке 9.1
таблица маршрутизации должна быть обновлена
либо с использованием маршрутизирующего демона,
либо с использованием перенаправления, однако не
с использованием и того и другого.) </small></p>

<p><small>Когда <a NAME="t095009"></a>4.4BSD функционирует как
маршрутизатор, осуществляются следующие
проверки, причем каждая из них должна быть
истиной, для того чтобы было сгенерировано ICMP
перенаправление.</small> 

<ol>
  <li><small>Исходящий и входящий интерфейс один и тот
    же.</small></li>
  <li><small>Маршрут, который будет использоваться для
    исходящей датаграммы, не должен быть создан или
    модифицирован с использованием ICMP
    перенаправления. Также он не должен быть
    маршрутом по умолчанию для маршрутизатора.</small></li>
  <li><small>Датаграмма не должна быть
    смаршрутизирована от источника.</small></li>
  <li><small>Ядро должно быть сконфигурировано таким
    образом, чтобы посылать перенаправления.</small></li>
</ol>

<p>&nbsp;</p>


<p>Переменная ядра с
именем <a NAME="t095010"></a>ip_sendredirects (или похожим). (См. <a HREF="tcp_e.html">приложение Е</a>.) Большинство
современных систем (4.4BSD, <a NAME="t095011"></a>SunOS 4.1.x, <a NAME="t095012"></a>Solaris&nbsp;2.x и <a NAME="t095013"></a>AIX 3.2.2, например)
включают эту переменную по умолчанию. Другие
системы, например, <a NAME="t095014"></a>SVR4, имеют эту
переменную по умолчанию выключенной.</p>


<p>&nbsp;</p>

<p><small>В дополнение, хост 4.4BSD, который принимает ICMP
перенаправления, осуществляет некоторые
проверки перед модификацией своей таблицы
маршрутизации. Это предотвращает странное
поведение маршрутизатора или хоста, вызванное
некорректной модификацией таблицы
маршрутизации системы.</small> 

<ol>
  <li><small>Новый маршрутизатор должен быть в
    непосредственно подключенной сети.</small></li>
  <li><small>Перенаправление должно быть от текущего
    маршрутизатора на указанный пункт назначения.</small></li>
  <li><small>Перенаправление не может заставить хост
    использовать самого себя в качестве
    маршрутизатора.</small></li>
  <li><small>Модифицируемый маршрут должен быть
    непрямым маршрутом.</small></li>
</ol>

<p><small>И в заключение стоит повториться, что
маршрутизаторы должны посылать только
перенаправления к хостам (codes 1 или 3 на рисунке 9.5),
а не перенаправления к сетям. Из-за разделения на
подсети не всегда можно однозначно указать,
когда должно быть послано перенаправление к сети
вместо перенаправления к хосту. Некоторые хосты
воспринимают принятое перенаправление к сети
как перенаправление к хосту, в том случае если
маршрутизатор послал неверный <a NAME="t095015"></a>тип
(type).</small></p>
<u><b>

<p><a NAME="t096000"></a>ICMP сообщения поиска маршрутизатора
(ICMP Router Discovery Messages) </p>
</b></u>

<p><small>Ранее в этой главе мы говорили, что одним из
способов инициализации таблицы маршрутизации
является создание статических маршрутов,
которые заносятся в конфигурационные файлы.
Подобный метод часто используется для установки
маршрута по умолчанию. Существует способ,
заключающийся в использовании ICMP объявлений
маршрутизаторов. </small></p>

<p><small>Основной принцип заключается в том, что
после загрузки хост рассылает широковещательные
или групповые запросы с требованием сообщить ему
о маршрутизаторе. Один или несколько
маршрутизаторов отвечают с использованием
сообщения об объявлении маршрутизатора. В
дополнение, маршрутизаторы периодически
рассылают широковещательные или групповые
сообщения с объявлением маршрутизатора,
позволяя каждому хосту, который примет эти
сообщения, обновить свои таблицы маршрутизации. </small></p>

<p><small>RFC 1256 [Deering 1991] содержит формат этих ICMP
сообщений. На рисунке&nbsp;9.6 показан формат ICMP
сообщения запроса маршрутизатора. На рисунке 9.7
показан формат ICMP сообщения объявления
маршрутизатора, которое рассылается
маршрутизаторами. </small></p>

<p><small>В одном сообщении маршрутизатор может
объявить несколько адресов. Поле количества
адресов. Размер записи адреса - количество
32-битных слов для каждого адреса маршрутизатора,
оно всегда установлено в 2. Время жизни -
количество секунд, в течение которого данное
объявление адресов считается действительным.<a NAME="t096001"></a>&nbsp;</small></p>


<p ALIGN="CENTER"><small><img SRC="t9_60000.jpg" WIDTH="511" HEIGHT="89"></small></p>


<p ALIGN="CENTER"><small>Рисунок 9.6 Формат ICMP сообщения
запроса маршрутизатора.</small></p>

<p ALIGN="CENTER">&nbsp;</p>


<p ALIGN="CENTER"><small><img SRC="t9_70000.jpg" WIDTH="510" HEIGHT="307"></small></p>


<p ALIGN="CENTER"><small><a NAME="t096002"></a>Рисунок 9.7 Формат ICMP
сообщения объявления маршрутизатора.</small></p>

<p>&nbsp;</p>

<p><small>Затем следует одна или несколько пар IP
адресов. IP адрес должен быть одним из адресов
посылающего маршрутизатора. Уровень
предпочтительности - это 32-битное целое число со
знаком, указывающее на предпочтительность этого
адреса в качестве адреса маршрутизатора по
умолчанию, по сравнению с другими адресами
маршрутизаторов в той же подсети. Большее
значение указывает на большую
предпочтительность адреса. Уровень
предпочтительности 0x80000000 указывает на то, что
соответствующий адрес, несмотря на то что он
объявлен, не должен быть использован получателем
в качестве адреса маршрутизатора по умолчанию.
Обычное значение предпочтительности это 0.</small></p>
<i><b>

<p>Функционирование маршрутизатора</p>
</b></i>

<p><small>Когда маршрутизатор стартует, он начинает
периодически рассылать объявления на все
интерфейсы, которые поддерживают групповой и
широковещательный тип адресации. В
действительности эти объявления не
периодические, они рассылаются случайным
образом. Это сделано для того, чтобы объявления
не перемешивались и не синхронизировались с
другими маршрутизаторами в той же подсети.
Обычный интервал между объявлениями составляет
от 450 до 600 секунд. Время жизни по умолчанию для
каждого объявления составляет 30 минут. </small></p>

<p><small>Поле времени жизни также используется,
когда интерфейс маршрутизатора выключается. В
этом случае маршрутизатор может передать
последнее объявление с временем жизни,
установленным в 0. </small></p>

<p><small>Помимо периодических объявлений,
маршрутизатор отвечает на запросы от хостов. Он
отвечает на запросы объявлением маршрутизатора. </small></p>

<p><small>Если в одной подсети существует несколько
маршрутизаторов, задача системного
администратора сконфигурировать уровень
предпочтительности для каждого маршрутизатора.
Например, основной маршрутизатор по умолчанию
должен иметь более высокий уровень
предпочтительности по отношению к запасному
маршрутизатору.</small></p>
<i><b>

<p>Функционирование хоста</p>
</b></i>

<p><small>При старте хост обычно посылает три запроса
о поиске маршрутизатора с интервалом в 3 секунды.
После того как принято объявление от
маршрутизатора, запросы прекращаются. </small></p>

<p><small>Хост также слушает объявления от
маршрутизатора. Эти объявления могут привести к
смене маршрутизатора по умолчанию для данного
хоста. Если объявление не получено для текущего
маршрута по умолчанию, он может быть удален по
тайм-ауту. </small></p>

<p><small>Пока текущий маршрутизатор по умолчанию
функционирует, он отправляет объявления каждые 10
минут с временем жизни в 30 минут. Это означает,
что маршрут по умолчанию в таблице маршрутизации
хоста не будет удален по тайм-ауту, даже если одно
или два объявления будут потеряны.</small></p>
<i><b>

<p>Реализация</p>
</b></i>

<p><small>Сообщения о поиске маршрутизатора обычно
генерируются и обрабатываются
пользовательскими процессами (демонами). Поэтому
добавляется еще один программный способ
обновления таблицы маршрутизации к тем, что
показаны на рисунке 9.1, несмотря на то, что он
может добавить или удалить только пункт по
умолчанию. Демон должен быть сконфигурирован
так, чтобы выступать либо в роли маршрутизатора,
либо в роли хоста.</small></p>

<p>&nbsp;</p>


<p>Эти два ICMP сообщения
достаточно новы и поддерживаются не всеми
системами. В нашей сети их поддерживает только <a NAME="t096003"></a>Solaris 2.x (демон <a NAME="t096004"></a>in.rdisc).
Несмотря на то, что RFC рекомендует использовать
групповую адресацию IP, где это возможно, поиск
маршрутизаторов может осуществляться с
использованием широковещательных сообщений.</p>


<p><small><a NAME="t097000"></a>&nbsp;</small></p>
<u><b>

<p>Краткие выводы</p>
</b></u>

<p><small>IP маршрутизация это краеугольный камень, на
котором держится функционирование систем,
использующих TCP/IP, будь то хост или маршрутизатор.
Записи в таблице маршрутизации довольно просты:
до 5 флаговых битов, IP адрес назначения (хост, сеть
или по умолчанию), IP адрес маршрутизатора
следующей пересылки (для непрямого маршрута) или
IP адрес локального интерфейса (для прямого
маршрута) и указатель на используемый локальный
интерфейс. Записи, соответствующие хостам, имеют
более высокий приоритет, чем записи,
соответствующие сетям, а оба типа записей имеют
более высокий приоритет по сравнению с маршрутом
по умолчанию. </small></p>

<p><small>Просмотр таблицы маршрутизации
осуществляется для каждой IP датаграммы, которую
система генерирует или пропускает через себя.
Таблица маршрутизации может быть обновлена с
помощью демона маршрутизации или <a NAME="t097001"></a>ICMP
перенаправления. По умолчанию система никогда не
пропустит через себя датаграмму, если система не
сконфигурирована как маршрутизатор. Статические
маршруты могут быть добавлены с помощью команды <a NAME="t097002"></a>route, а ICMP сообщения поиска
маршрутизатора могут быть использованы для
инициализации и динамического обновления
маршрутов по умолчанию. Хост может запуститься с
очень простой таблицей маршрутизации, которая
динамически обновляется с помощью ICMP
перенаправлений, приходящих с маршрутизатора по
умолчанию. </small></p>

<p><small>Эта глава была посвящена тому, как
отдельная система использует свою таблицу
маршрутизации. В следующей главе мы рассмотрим,
как маршрутизаторы обмениваются друг с другом
маршрутной информацией.</small></p>
<i><b>

<p>Упражнения</b></i> 

<ol>
  <li>Как Вы думаете, почему
    существуют два типа ICMP перенаправлений - на сеть
    и на хост?</li>
  <li>Обратитесь к таблице маршрутизации
    хоста svr4, показанной в начале раздела <a HREF="#t092000">&quot;Принципы
    маршрутизации&quot;</a>. Является ли необходимым
    указание маршрута на хост slip (140.252.13.65)? Что
    изменится, если этот пункт будет удален из
    таблицы маршрутизации?</li>
  <li>Представьте, что существует кабель
    между <a NAME="t097003"></a>4.2BSD и <a NAME="t097004"></a>4.3BSD хостами.
    Также представьте, что идентификатор сети - 140.1.
    Хост 4.2BSD распознает в качестве
    широковещательных адресов только адреса с
    идентификаторами хостов, установленными во все
    нули (140.1.0.0), тогда как хост 4.3BSD обычно отправляет
    широковещательные сообщения с идентификаторами
    хостов, состоящих из всех единичных битов
    (140.1.255.255). Также, хост 4.2BSD по умолчанию старается
    перенаправить входящие датаграммы, даже если он
    имеет только один интерфейс. Опишите, что
    произойдет, когда хост 4.2BSD получает IP датаграммы
    с адресом назначения 140.1.255.255.</li>
  <li>Продолжим предыдущее упражнение.
    Представьте себе, что кто-либо исправил эту
    проблему, добавив запись в ARP кэш на одной из
    систем в подсети 140.1. (воспользовавшись командой <a NAME="t097005"></a>arp), сказав при этом, что IP адрес 140.1.255.255
    соответствует Ethernet адресу из всех единичных
    битов (широковещательный запрос Ethernet). Опишите,
    что произойдет в этом случае.</li>
  <li>Просмотрите таблицу маршрутизации
    Вашей системы и опишите каждую запись.</li>
</ol>

<hr>

</body>
</html>
