<html>

<head>
<title>ICMP: Протокол управления сообщениями Internet</title>

<meta http-equiv="Content-type" content="text/html; charset=koi8-r">
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>




<p><a NAME="t060000"></a>Глава 6 ICMP: протокол управления
сообщениями Internet</p>
<u>

<p><b><a NAME="t061000"></a>Введение</p>
</b></u>

<p><small>Обычно считается, что ICMP это часть IP уровня.
С его помощью передаются сообщения об ошибках и
сообщения о возникновении условий и ситуаций,
которые требуют к себе особого внимания. ICMP
сообщения обрабатываются IP уровнем или более
высокими уровнями (TCP или UDP). При появлении
некоторых ICMP сообщений генерируются сообщения
об ошибках, которые передаются пользовательским
процессам. </small></p>

<p><small>ICMP сообщения передаются внутри IP датаграмм,
как показано на рисунке 6.1.<a NAME="t061001"></a></small></p>


<p ALIGN="CENTER"><small><img SRC="t6_10000.jpg" WIDTH="314" HEIGHT="75"></small></p>


<p ALIGN="CENTER"><small>Рисунок 6.1 Инкапсуляция ICMP
сообщений в IP датаграммы.</small></p>

<p>&nbsp;</p>

<p><small>Официальная спецификация ICMP находится в RFC
792 [<a NAME="t061002"></a>Postel 1981b]. </small></p>

<p><small>На рисунке 6.2 показан формат ICMP сообщения.
Первые 4 байта одинаковы для всех сообщений,
однако остальные отличаются в зависимости от
типа сообщения. Мы будем показывать точный
формат каждого сообщения, по мере того как будем
их описывать. </small></p>

<p><small>Существует 15 различных значений для поля
типа (type), которые указывают на конкретныей тип ICMP
сообщения. Для некоторых ICMP сообщений
используются различные значения в поле кода (code),
подобным образом осуществляется дальнейшее
подразделение ICMP сообщений. </small></p>

<p><small>Поле <a NAME="t061003"></a>контрольной суммы (checksum)
охватывает ICMP сообщения целиком. Алгоритм,
используемый при этом, такой же как тот, что был
описан в разделе <a HREF="tcp03.html#t032000">&quot;IP
заголовок&quot;</a> главы 3 при расчете контрольной
суммы IP заголовка. Контрольная сумма ICMP
присутствует всегда.<a NAME="t061004"></a></small></p>


<p ALIGN="CENTER"><small><img SRC="t6_20000.jpg" WIDTH="480" HEIGHT="148"></small></p>


<p ALIGN="CENTER"><small>Рисунок 6.2 ICMP сообщение.</small></p>

<p>&nbsp;</p>

<p><small>В этой главе мы рассмотрим ICMP сообщения в
целом, некоторые из них подробно: запрос и отклик
маски адреса, запрос и отклик временной марки и
сообщение о недоступности порта. В <a HREF="tcp07.html">главе
7</a> мы обсудим, с использованием программы Ping, эхо
запрос и эхо отклик, а в <a HREF="tcp09.html">главе 9</a>
рассмотрим ICMP сообщения, связанные с IP
маршрутизацией.</small></p>
<u><b>

<p><a NAME="t062000"></a>Типы сообщений ICMP</p>
</b></u>

<p><small>На рисунке 6.3 приведены возможные типы ICMP
сообщений, как они определяются полями типа (type) и
кода (code). </small></p>

<p><small>Последние две колонки на рисунке указывают,
является ли ICMP сообщение запросом (query) или
сообщением об ошибке (error). Подобное разделение
необходимо, потому что сообщения об ошибках ICMP
иногда обрабатываются специальным образом.
Например, ICMP сообщение об ошибке никогда не
генерируется в ответ на ICMP сообщение об ошибке.
(Если не придерживаться этого правила, то ошибка
будет генерироваться на ошибку до
бесконечности.) </small></p>

<p><small>Когда посылается ICMP сообщение об ошибке,
оно всегда содержит IP заголовок и первые 8 байт IP
датаграммы, которая вызвала генерацию ICMP ошибки.
Это позволяет принимающему ICMP модулю установить
соответствие между полученным сообщением, одним
из конкретных протоколов (TCP или UDP из <a NAME="t062003"></a>поля
протоколов в IP заголовке) и с одним из конкретных
пользовательских процессов (с помощью номера
порта TCP или UDP, который содержится в TCP или UDP
заголовке в первых 8 байтах IP датаграммы). В
разделе <a HREF="#t065000">&quot;ICMP ошибка недоступности
порта (ICMP Port Unreachable Error)&quot;</a> главы 6 мы рассмотрим
это более подробно. </small></p>

<p><small>Сообщение об ошибке ICMP никогда не
генерируется в ответ на:</small> 

<ol>
  <li><small>ICMP сообщение об ошибке. (ICMP сообщение об
    ошибке, однако, может быть сгенерировано в ответ
    на ICMP запрос.)</small></li>
  <li><small>Датаграмму, направляющуюся на
    широковещательный IP адрес (рисунок 3.9) или
    групповой адрес IP (адрес класса D, рисунок 1.5).</small></li>
  <li><small>Датаграмму, которая посылается
    широковещательным запросом на канальном уровне.</small></li>
  <li><small>Фрагмент, который не является первым. (Мы
    опишем фрагментацию в разделе <a HREF="tcp11.html#t115000">&quot;Фрагментация
    IP&quot;</a> главы 11.) </small></li>
  <li><small>Датаграмму, адрес источника которой не
    указывает на конкретный хост. Это означает, что
    адрес источника не может быть нулевым, <a NAME="t062002"></a>loopback
    адресом, широковещательным или групповым
    адресом.<a NAME="t062001"></a></small></li>
</ol>

<p>&nbsp;</p>


<table BORDER="1" CELLSPACING="1" BORDERCOLOR="#000000" CELLPADDING="5" WIDTH="732">
  <tr>
    <td WIDTH="7%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>тип</small></td>
    <td WIDTH="7%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>код</small></td>
    <td WIDTH="64%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>Описание</small></td>
    <td WIDTH="11%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>запрос</small></td>
    <td WIDTH="11%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>ошибка</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>эхо-отклик
    (отклик-Ping, <a HREF="tcp07.html">глава 7</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>3</small></td>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="64%" VALIGN="TOP"><small>назначение
    недоступно:</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>сеть недоступна -
    network unreachable (раздел <a HREF="tcp09.html#t093000">&quot;ICMP ошибки о
    недоступности хоста и сети&quot;</a> главы 9)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>хост недоступен -
    host unreachable (раздел <a HREF="tcp09.html#t093000">&quot;ICMP ошибки о
    недоступности хоста и сети&quot;</a> главы 9)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>2</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>протокол
    недоступен - protocol unreachable</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>3</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>порт недоступен -
    port unreachable (раздел <a HREF="#t065000">&quot;ICMP ошибка
    недоступности порта (ICMP Port Unreachable Error)&quot;</a> главы
    6)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>4</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>необходима
    фрагментация, однако установлен бит ⌠не
    фрагментировать■- fragmentation needed but don▓t-fragment bit set
    (раздел <a HREF="tcp11.html#t116000">&quot;ICMP ошибки о
    недоступности&quot;</a> главы 11)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>5</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>не работает
    маршрутизация от источника - source route failed (глава 8,
    раздел <a HREF="tcp08.html#t085000">&quot;Опция IP маршрутизации
    от источника&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>6</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>неизвестна сеть
    назначения - destination network unknown</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>7</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>неизвестен хост
    назначения - destination host unknown</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>8</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>хост источник
    изолирован - source host isolated</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>9</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>сеть назначения
    закрыта администратором - destination network administrativrly
    prohibited</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>10</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>хост назначения
    закрыт администратором - destination host administrativrly prohibited</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>11</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>сеть недоступна
    для TOS - network unreachable for TOS (глава 9, раздел <a HREF="tcp09.html#t093000">&quot;ICMP ошибки о недоступности хоста
    и сети&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>12</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>хост недоступен
    для TOS - host unreachable for TOS (глава 9, раздел <a HREF="tcp09.html#t093000">&quot;ICMP ошибки о недоступности хоста
    и сети&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>13</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>связь
    административно закрыта путем фильтрации -
    communication administratively prohibited by filtering </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>14</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>нарушено
    старшинство для хоста - host precedence violation </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>15</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>старшинство
    разъединено - precedence cutoff in effect </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>4</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>подавление
    источника (элементарное управление потоком
    данных) - source quench (глава 11, раздел <a HREF="tcp11.html#t11B000">&quot;ICMP
    ошибка подавления источника&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>5</small></td>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="64%" VALIGN="TOP"><small>перенаправление -
    redirect (глава 11, раздел <a HREF="tcp11.html#t11B000">&quot;ICMP ошибка
    подавления источника&quot;</a>): </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>перенаправление в
    сеть - redirect for network </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>перенаправление в
    хост - redirect for host</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>2</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>перенаправление
    для типа сервиса и сети - redirect for type-of-service and network</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>3</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>перенаправление
    для типа сервиса и хоста - redirect for type-of-service and host</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>8</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>эхо запрос - echo request
    (Ping запрос, <a HREF="tcp07.html">глава 7</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>9</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>объявление
    маршрутизатора - router advertisement (глава 9, раздел <a HREF="tcp09.html#t096000">&quot;ICMP сообщения поиска
    маршрутизатора&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>10</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>запрос к
    маршрутизатору - router solicitation (глава 9, раздел <a HREF="tcp09.html#t096000">&quot;ICMP сообщения поиска
    маршрутизатора&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>11</small></td>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="64%" VALIGN="TOP"><small>время истекло - time
    exceeded:</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>время жизни стало
    равным 0 в процессе передачи - time-to-live equals 0 during transit
    (Traceroute, <a HREF="tcp08.html">глава 8</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>время жизни стало
    равным 0 в процессе повторной сборки - time-to-live equals 0
    during reassembly (глава 11, раздел <a HREF="tcp11.html#t115000">&quot;Фрагментация
    IP&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>12</small></td>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="64%" VALIGN="TOP"><small>проблемы с
    параметрами - parameter problem:</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>неверный IP
    заголовок - IP header bad</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>отсутствует
    необходимая опция - required option missing</small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>13</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>запрос временной
    марки - timestamp request (глава 6, раздел <a HREF="#t064000">&quot;ICMP
    запрос и отклик временной марки&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>14</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>отклик с временной
    маркой - timestamp reply (глава 6, раздел <a HREF="#t064000">&quot;ICMP
    запрос и отклик временной марки&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>15</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>информационный
    запрос - information request </small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>16</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>информационный
    отклик - information reply </small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>17</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>запрос маски
    адреса - address mask request (глава 6, раздел <a HREF="#t063000">&quot;ICMP
    запрос и отклик маски адреса&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>18</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="64%" VALIGN="TOP"><small>отклик с маской
    адреса - address mask reply (глава 6, раздел <a HREF="#t063000">&quot;ICMP
    запрос и отклик маски адреса&quot;</a>)</small></td>
    <td WIDTH="11%" VALIGN="TOP"><p ALIGN="CENTER"><small>╥ </small></td>
    <td WIDTH="11%" VALIGN="TOP">&nbsp;</td>
  </tr>
</table>


<p><small>Рисунок 6.3 Типы сообщений ICMP.</small></p>

<p>&nbsp;</p>

<p><small>Эти правила введены для того, чтобы
предотвратить лавинообразный рост количества
широковещательных сообщений, который может
произойти, если ICMP сообщения об ошибках будут
отправляться в ответ на широковещательные
пакеты.</small></p>
<u><b>

<p><a NAME="t063000"></a>ICMP запрос и отклик маски адреса</p>
</b></u>

<p><small>ICMP запрос маски адреса используется
бездисковыми системами, чтобы получить маску
подсети (глава 3, раздел <a HREF="tcp03.html#t035000">&quot;Маска
подсети&quot;</a>) во время загрузки. Система
посылает широковещательный ICMP запрос. (Это
напоминает то, как бездисковые системы с
использованием RARP получают свои IP адреса во
время загрузки.) Альтернативный метод для
бездисковых систем получить маски своих
подсетей - протокол BOOTP, о котором рассказано в <a HREF="tcp16.html">главе 16</a>. На рисунке 6.4 показан формат
ICMP запроса и отклика маски адреса.<a NAME="t063001"></a></small></p>

<p>&nbsp;</p>


<p ALIGN="CENTER"><small><img SRC="t6_40000.jpg" WIDTH="518" HEIGHT="128"></small></p>


<p ALIGN="CENTER"><small>Рисунок 6.4 ICMP запрос и отклик маски
адреса.</small></p>

<p>&nbsp;</p>

<p><small>Поля идентификатора и номера
последовательности в ICMP сообщении могут быть
установлены по выбору отправителя, эти же
значения будут возвращены в отклике. Именно
таким образом отправитель идентифицирует отклик
на свой запрос. </small></p>

<p><small>Мы можем написать простую программу
(которая называется <a NAME="t063002"></a>icmpaddrmask), которая
выдает ICMP запрос маски адреса и печатает все
отклики. Обычно, запрос отправляется на <a NAME="t063003"></a>широковещательный
адрес, мы поступим точно так же. Адрес назначения
(140.252.13.63) это широковещательный адрес для подсети
140.252.13.32 (см. рисунок 3.12).</small></p>

<p>&nbsp;</p>


<p>sun % <b>icmpaddrmask 140.252.13.63</b><br>
received mask = ffffffe0, from 140.252.13.33
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; от самого себя<br>
received mask = ffffffe0, from 140.252.13.35
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; от bsdi<br>
received mask = ffff0000, from 140.252.13.34
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; от svr4<br>
</p>


<p>&nbsp;</p>

<p><small>Первое, на что стоит обратить внимание в
выводе программы, это то, что значение,
возвращенное от svr4, неверно. Это произошло из-за
того, что <a NAME="t063004"></a>SVR4 возвращает общую маску
подсети класса В, подразумевающую, что деление на
подсети не осуществлено, даже несмотря на то что
интерфейс svr4 сконфигурирован с правильной
маской подсети:</small></p>

<p>&nbsp;</p>


<p>svr4 % <b>ifconfig emd0</b><br>
emd0: flags=23&lt;UP, BROADCAST, NOTRAILERS.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inet 140.252.13.34 netmask ffffffe0 broadcast 140.252.13.63<br>
</p>


<p>&nbsp;</p>

<p><small>Это одна из известных ошибок SVR4 возникающая
при обработке ICMP запросов маски адреса. </small></p>

<p><small>Мы рассмотрим обмен пакетами для хоста bsdi,
используя tcpdump. Вывод показан на рисунке 6.5. Была
использована опция <a NAME="t063005"></a>-e, которая
позволяет посмотреть аппаратные адреса.<a NAME="t063006"></a></small></p>

<p>&nbsp;</p>


<p>1 0.0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8:0:20:3:f6:42
ff:ff:ff:ff:ff:ff ip 60: <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sun
&gt; 140.252.13.63: icmp: address mask request<br>
2 0.00 (0.00)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0:0:c0:6f:2d:40 ff:ff:ff:ff:ff:ff ip 46: <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bsdi
&gt; sun: icmp: address mask is 0xffffffe0<br>
3 0.01 (0.01)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0:0:c0:6f:2d:40 8:0:20:3:f6:42 ip 60: <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; svr4
&gt; sun: icmp: address mask is 0xffff0000<br>
</p>


<p>&nbsp;</p>

<p><small>Рисунок 6.5 ICMP запрос маски адреса,
отправленный на широковещательный адрес.</small></p>

<p>&nbsp;</p>

<p><small>Обратите внимание на то, что посылающий
хост, sun, принимает ICMP отклик (строка вывода с
комментарием &quot;от самого себя&quot;, которая была
показана ранее), даже если &quot;в кабеле&quot; ничего
не было. Это основная характеристика
широковещательных запросов: посылающий хост
принимает копию широковещательного пакета через
внутренний механизм loopback. Так как по определению
термин &quot;широковещательный запрос&quot; означает
все хосты в локальной сети, сюда же включается и
посылающий хост. (Если обратиться к рисунку 2.4,
можно увидить, что драйвер Ethernet, определив, что
адрес назначения является широковещательным,
посылает пакет в сеть и копирует его в интерфейс
loopback.) </small></p>

<p><small>Затем bsdi отправляет широковещательным
запросом отклик, тогда как svr4 посылает отклик
только тому, кто отправил запрос. Обычно отклик
должен быть персональным, если только IP адрес
источника в запросе не установлен в 0.0.0.0,
отправка откликов на широковещательный адрес
это ошибка, допущенная в <a NAME="t063007"></a>BSD/386.</small></p>

<p>&nbsp;</p>


<p>Требования к хостам <a NAME="t063008"></a>Host Requirements RFC гласят, что система не
должна отправлять отклик о маске адреса, если она
не является полномочным агентом для рассылки
масок адресов. (Чтобы являтьься полномочным
агентом и рассылать подобные отклики, система
должна быть специально сконфигурирована. (См. <a HREF="tcp_e.html">приложение Е</a>.) Однако, как мы видим из
этого примера, большинство реализаций посылают
отклик в ответ на полученный запрос. Иногда хосты
даже посылают неверные отклики!</p>


<p>&nbsp;</p>

<p><small>Обратимся к следующему примеру. Мы посылаем
запрос о маске адреса на свой собственный IP адрес
и на loopback адрес:</small></p>

<p>&nbsp;</p>


<p>sun % <b>icmpaddrmask sun<br>
</b>received mask = ff000000, from 140.252.13.33<br>
<br>
sun % <b>icmpaddrmask localhost<br>
</b>received mask = ff000000, from 127.0.0.1&nbsp;</p>

<p>&nbsp;</p>

<p><small>В обоих случаях возвращенная маска адреса
соответствует адресу loopback, адресу 127.0.0.1 сети
класса А. Снова обратившись к рисунку 2.4 мы
увидим, что IP датаграммы, посланные на
собственный IP адрес хоста (140.252.13.33 в данном
примере), в действительности посылаются на <a NAME="t063009"></a>loopback интерфейс. ICMP отклик о маске
адреса должен соответствовать маске подсети
интерфейса, на которой был принят запрос (при
этом хост с несколькими интерфейсами может иметь
различные маски подсети для каждого интерфейса),
а в нашем случае оба запроса получены с
интерфейса loopback.</small></p>
<u><b>

<p><a NAME="t064000"></a>ICMP запрос и отклик временной марки</p>
</b></u>

<p><small>ICMP запрос временной марки позволяет
системе запросить другую систему о текущем
времени. Рекомендуемое значение, которое должно
быть возвращено, это количество миллисекунд,
которые прошли с полуночи в формате UTC, (<a NAME="t064001"></a>Универсальное
согласованное время - Coordinated Universal Time). (В старых
руководствах UTC называется Среднее время по
Гринвичу - Greenwich Mean Time.) Одна из основных
особенностей ICMP сообщения заключается в том, что
оно предоставляет время в с точностью до
миллисекунд, тогда как другие методы
используемые для получения времени от удаленных
систем (например, команда <a NAME="t064002"></a>rdate,
существующая в некоторых UNIX системах)
предоставляют время с точностью до секунд.
Недостаток заключается в том, что сообщается
только время, прошедшее с полуночи, -
запрашивающая система должена знать текущую
дату. На рисунке 6.6 показан формат ICMP запроса и
формат ICMP отклика временной марки.<a NAME="t064003"></a></small></p>

<p>&nbsp;</p>


<p ALIGN="CENTER"><small><img SRC="t6_60000.jpg" WIDTH="516" HEIGHT="207"></small></p>


<p ALIGN="CENTER"><small>Рисунок 6.6 ICMP запрос и отклик
временной марки.</small></p>

<p>&nbsp;</p>

<p><small>Запрашивающий заполняет исходную
временную марку и отправляет запрос. Отвечающая
система заполняет временную марку приема, когда
получает запрос, и временную марку передачи,
когда отправляет отклик. Большинство реализаций
устанавливают в два последних поля одно и то же
значение. (Причина, по которой существуют три
поля, заключается в том, что отправителю
необходимо вычислить время, которое
потребовалось на отправку запроса, и отдельно
рассчитать время, которое потребуется на
отправку отклика.)</small></p>
<i><b>

<p>Примеры</p>
</b></i>

<p><small>Воспользуемся простой программой (которая
называется <a NAME="t064004"></a>icmptime), которая посылает ICMP
запрос временной марки и печатает полученный
отклик. Запустим эту программу в нашей маленькой
сети:</small></p>

<p>&nbsp;</p>


<p>sun %<b> icmptime bsdi<br>
</b>orig = 83573336, recv = 83573330, xmit = 83573330, rtt = 2 ms<br>
difference = -6 ms<br>
<br>
sun % <b>icmptime bsdi<br>
</b>orig = 83577987, recv = 83577980, xmit = 83577980, rtt = 2 ms<br>
difference = -7 ms&nbsp;</p>

<p>&nbsp;</p>

<p><small>Программа выдала три временные марки из ICMP
сообщения: исходную (orig), приема (recv) и передачи
(xmit). Из этого и следующих примеров видно, что все
хосты установили временные марки приема и
передачи в одно и то же значение. </small></p>

<p><small><a NAME="t064005"></a>Также мы рассчитали время
возврата (rtt) , которое рассчитывается как время,
когда был принят отклик, минус время, когда был
отправлен запрос. difference - это временная марка
приема минус исходная временная марка. На
рисунке 6.7 показана взаимосвязь между этими
значениями.<a NAME="t064006"></a></small></p>


<p ALIGN="CENTER"><small><img SRC="t6_70000.jpg" WIDTH="441" HEIGHT="75"></small></p>


<p ALIGN="CENTER"><small>Рисунок 6.7 Взаимосвязь между
значениями, напечатанными программой icmptime.</small></p>

<p>&nbsp;</p>

<p><small>Если принять за истину то, что одна половина
RTT отводится под запрос, а другая половина под
отклик, тогда <a NAME="t064007"></a>часы отправителя
должны быть настроены как difference минус половина
RTT, чтобы иметь то же самое время, как у хоста к
которому отправляется запрос. В предыдущем
примере часы bsdi отставали на 7 и 8
миллисекунд от часов sun. </small></p>

<p><small>Так как временная марка является
количеством миллисекунд после полуночи, UTC
должны быть всегда меньше чем 86400000 (24х60х60х1000). Эти
примеры были исполнены сразу после 16:00 во
временной зоне имеющей отставание на 7 часов от
UTC, таким образом, приемлемыми являются значения
больше чем 82800000 (2300 часов). </small></p>

<p><small>Если мы запустим эту программу несколько
раз на хост bsdi, то увидим, что последние цифры во
временной марке передачи и приема всегда равны
нулю. Это происходит из-за того, что программный
релиз (Version 0.9.4) имеет часы с точностью 10
миллисекунд. (Мы опишем это в <a HREF="tcp_b.html">приложении
В</a>.) </small></p>

<p><small>Если мы запустим программу дважды на хост
svr4, то увидим что уже три младшие цифры во
временной марке <a NAME="t064008"></a>SVR4 равны нулю:</small></p>

<p>&nbsp;</p>


<p>sun % <b>icmptime svr4<br>
</b>orig = 83588210, recv = 83588000, xmit = 83588000, rtt = 4 ms<br>
difference = -210 ms<br>
<br>
sun % <b>icmptime svr4<br>
</b>orig = 83591547, recv = 83591000, xmit = 83591000, rtt = 4 ms<br>
difference = -547 ms&nbsp;</p>

<p><small>По каким-то причинам SVR4 не предоставляет
разрешение времени с точностью до миллисекунд
при использовании временной марки ICMP. Подобная
неточность делает расчет разницы во времени
бесполезным, если разговор идет о миллисекундах. </small></p>

<p><small>Если мы обратимся к двум другим хостам в
подсети 140.252.1, то увидим, что установка одних
часов отличается от установки часов sun на 3,7
секунды, а других на 75 секунд:</small></p>


<p>sun %<b> icmptime gemini<br>
</b>orig = 83601883, recv = 83598140, xmit = 83598140, rtt = 247 ms<br>
difference = -3743 ms<br>
<br>
sun % <b>icmptime aix<br>
</b>orig = 83606768, recv = 83532183, xmit = 83532183, rtt = 253 ms<br>
difference = -74585 ms&nbsp;</p>

<p><small>Другой интересный пример может быть
получен при обращении к маршрутизатору gateway
(маршрутизатор Cisco). Из примера видно, что если
система возвращает нестандартное значение
временной марки (отличающееся от количества
миллисекунд после полуночи, UTC), старшие биты в
32-битной временной марке устанавливаются в
единицу. Наша программа определяет это и
печатает временные марки приема и передачи в
треугольных скобках (после установки старших
битов в ноль). Мы можем рассчитать разницу между
исходной временной маркой и временной маркой
приема.</small></p>


<p>sun %<b> icmptime gateway<br>
</b>orig = 83620811, recv = &lt;4871036&gt;, xmit = &lt;4871036&gt;, rtt = 220 ms<br>
<br>
sun % <b>icmptime gateway<br>
</b>orig = 83641007, recv = &lt;4891232&gt;, xmit = &lt;4891232&gt;, rtt = 213 ms&nbsp;</p>

<p>&nbsp;</p>

<p><small>Если запустить нашу программу на этот хост
несколько раз, то можно заметить, что полученные
значения имеют точность до миллисекунд и
содержит количество миллисекунд с какой-то
начальной точки, однако начальная точка не
полночь, UTC. (Это может быть, например, счетчик,
который увеличивается на единицу каждую
миллисекунду с момента загрузки маршрутизатора.)
</small></p>

<p><small>И в качестве последнего примера сравним
часы sun с часами системы, которые считаются
абсолютно точными - сервер NTP. (Мы расскажем о
протоколе сетевого времени <a NAME="t064009"></a>NTP - Network
Time Protocol, ниже.)</small></p>

<p>&nbsp;</p>


<p>sun % <b>icmptime clock.llnl.gov<br>
</b>orig = 83662791, recv = 83662919, xmit = 83662919, rtt = 359 ms<br>
difference = 128 ms<br>
<br>
sun %<b> icmptime clock.llnl.gov<br>
</b>orig = 83670425, recv = 83670559, xmit = 83670559, rtt = 345 ms<br>
difference = 134 ms&nbsp;</p>

<p>&nbsp;</p>

<p><small>Если вычесть из разницы (difference) половину RTT,
то можно будет сказать, что часы sun торопятся на
величину в диапазоне 51,5 - 38,5 миллисекунды.</small></p>
<i><b>

<p>Другие возможные варианты</p>
</b></i>

<p><small>Существуют другие способы получить время и
дату. </small>

<ol>
  <li><small>Мы описали сервис дневного времени и сервис
    времени в разделе <a HREF="tcp01.html#t01C000">&quot;Стандартные
    простые сервисы&quot;</a> главы 1. Первый возвращает
    текущую дату и время в формате, понятном для
    человека - в виде строк ACSII символов. Мы можем
    проверить работу этого сервиса с использованием
    команды <a NAME="t064010"></a>telnet:</small><p>sun %<b> telnet bsdi daytime</b><br>
    Trying 140.252.13.35 ...<br>
    Connected to bsdi.<br>
    Escape character is '^]'.
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; первые
    три строки - вывод Telnet клиента<br>
    Wed Feb 3 16:38:33 1993
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; это
    вывод сервиса дневного времени<br>
    Connection closed by foreign host.&nbsp;&nbsp;&nbsp;&nbsp; это опять вывод
    Telnet клиента<br>
    </p>
    <p><small>Сервер времени возвращает
    32-битное двоичное значение, содержащее
    количество секунд после полуночи 1 января 1900
    года, UTC. (Команда <a NAME="t064011"></a>rdate, которую мы
    упоминали ранее, использует сервис времени TCP.)</small></p>
  </li>
  <li><small>Для получения более точного времени
    используется протокол сетевого времени (<a NAME="t064012"></a>NTP - Network Time Protocol), который описан в RFC 1305 [<a NAME="t064013"></a>Mills 1992]. Этот протокол использует
    определенную технику поддержания точности часов
    для группы систем в локальной или глобальной
    сети с точностью до миллисекунды. Для более
    подробного изучения функционирования этого
    протокола, необходимо обратиться к RFC.</small></li>
  <li><small><a NAME="t064014"></a>Open Software Foundation (OSF) <a NAME="t064015"></a>Distributed
    Computing Environment (DCE) определяет <a NAME="t064016"></a>сервис
    распределенного времени (DTS - Distributed Time Service),
    который также осуществляет синхронизацию часов
    между хостами. <a NAME="t064017"></a>[Rosenberg, Kenney, and Fisher 1992]
    более подробно описывает этот сервис.</small></li>
  <li><small>В Unix системах Berkeley существует демон <a NAME="t064018"></a>timed(8) , который используется для
    синхронизации часов систем, находящихся в
    локальной сети. В отличие от NTP и DTS, timed не
    работает в глобальных сетях.</small></li>
</ol>

<p>&nbsp;</p>
<u><b>

<p><a NAME="t065000"></a>ICMP ошибка недоступности порта (ICMP
Port Unreachable Error) </p>
</b></u>

<p><small>В двух последних разделах описаны запросы
ICMP - маски адреса, и запросы и отклики временной
марки. Сейчас мы рассмотрим ICMP сообщения об
ошибках, а именно: сообщение о недоступности
порта, подкод сообщения ICMP о недоступности
пункта назначения. Также рассмотрим
дополнительную информацию, которая возвращается
в ICMP сообщении об ошибке. Для этого воспользуемся
UDP (<a HREF="tcp11.html">глава 11</a>). </small></p>

<p><small>Если UDP принимает датаграмму, порт
назначения которой не соответствует порту,
который обслуживается каким-либо процессом, UDP
выдает ICMP сообщение о недоступности порта.
Попробуем получить ошибку недоступности порта с
использованием TFTP клиента. (<a NAME="t065006"></a>TFTP
подробно описан в <a HREF="tcp15.html">главе 15</a>.) </small></p>

<p><small>TFTP сервер использует заранее-известный UDP
порт 69. Однако большинство программ TFTP клиента
позволяют указать другой порт с помощью команды
connect. В данном случае мы указали порт 8888: </small></p>

<p>&nbsp;</p>


<p>bsdi % <b>tftp</b><br>
tftp&gt; <b>connect svr4 8888 </b>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; указываем имя сервера
и номер порта<br>
tftp&gt; <b>get temp.foo </b>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; пробуем
получить файл<br>
Transfer timed out.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 25
секунд спустя истекает время таймера<br>
tftp&gt; <b>quit</b><br>
</p>


<p>&nbsp;</p>

<p><small>Команда connect сохраняет имя хоста, с которым
необходимо установить соединение, и номер порта
на этом хосте для дальнейшего использования
командой get. После того как введена команда get, UDP
датаграмма посылается на порт 8888 хоста svr4. На
рисунке 6.8 показан вывод команды <a NAME="t065012"></a>tcpdump,
иллюстрирующий обмен пакетами. </small></p>

<p><small>Перед тем как послать UDP датаграмму на svr4,
отправляется ARP запрос, для того чтобы определить
аппаратный адрес (строка 1). Возвращается ARP
отклик (строка 2), после чего отправляются UDP
датаграммы (строка 3). (Мы оставили ARP
запрос-отклик в выводе команды tcpdump, чтобы
напомнить Вам, что этот обмен необходим перед
отправкой первой IP датаграммы с одного хоста на
другой. В следующих примерах мы не будем
приводить ARP обмен.)<a NAME="t065003"></a> </small></p>

<p>&nbsp;</p>


<p> 1&nbsp;&nbsp; 0.0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; arp
who-has svr4 tell bsdi<br>
2&nbsp;&nbsp; 0.002050 (0.0020)&nbsp;&nbsp;&nbsp;&nbsp; arp reply svr4 is-at
0:0:c0:c2:9b:26<br>
<br>
3&nbsp;&nbsp; 0.002723 (0.0007)&nbsp;&nbsp;&nbsp;&nbsp; bsdi.2924 &gt; svr4.8888: udp 20<br>
4&nbsp;&nbsp; 0.006399 (0.0037)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp
port 8888 unreachable<br>
<br>
5&nbsp;&nbsp; 5.000776 (4.9944)&nbsp;&nbsp;&nbsp;&nbsp; bsdi.2924 &gt; svr4.8888: udp 20<br>
6&nbsp;&nbsp; 5.004304 (0.0035)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp
port 8888 unreachable<br>
<br>
7&nbsp; 10.000887 (4.9966)&nbsp;&nbsp;&nbsp;&nbsp; bsdi.2924 &gt; svr4.8888: udp 20<br>
8&nbsp; 10.004416 (0.0035)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp port
8888 unreachable<br>
<br>
9&nbsp; 15.001014 (4.9966)&nbsp;&nbsp;&nbsp;&nbsp; bsdi.2924 &gt; svr4.8888: udp 20<br>
10&nbsp; 15.004574 (0.0036)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp port
8888 unreachable<br>
<br>
11&nbsp; 20.001177 (4.9966)&nbsp;&nbsp;&nbsp;&nbsp; bsdi.2924 &gt; svr4.8888: udp 20<br>
12&nbsp; 20.004759 (0.0036)&nbsp;&nbsp;&nbsp;&nbsp; svr4 &gt; bsdi: icmp: svr4 udp port
8888 unreachable<br>
</p>


<p>&nbsp;</p>

<p><small>Рисунок 6.8 Генерация ICMP ошибки о
недоступности порта в ответ на TFTP запрос.</small></p>

<p>&nbsp;</p>

<p><small>ICMP ошибка о недоступности порта
возвращается немедленно (строка 4). Однако TFTP
клиент игнорирует ICMP сообщение и посылает
следующую UDP датаграмму примерно через 5 секунд
(строка 5). Это повторяется трижды, перед тем как
клиент прекращает свои попытки. </small></p>

<p><small>Обратите внимание на то, что ICMP сообщения
передаются между хостами без номера порта
назначения, тогда как каждая 20-байтовая UDP
датаграмма выходит из указанного порта (2924) в
указанный порт (8888). </small></p>

<p><small>Число 20 в конце каждой UDP строки это длина
данных в UDP датаграмме. В данном примере 20 - это
сумма двухбайтного кода операции (opcode) TFTP,
9-байтного имени (temp.foo) и 9-байтной строки netascii. (На
рисунке 15.1 подробно описано содержимое пакета
TFTP.) </small></p>

<p><small>Если мы запустим тот же пример с опцией <a NAME="t065004"></a>-e команды tcpdump, то увидим точную длину
каждого ICMP сообщения о недоступности порта,
которое возвращается отправителю. Длина
составляет 70 байт. (см. рисунок 6.9).<a NAME="t065005"></a></small></p>


<p ALIGN="CENTER"><small><img SRC="t6_90000.jpg" WIDTH="512" HEIGHT="132"></small></p>


<p ALIGN="CENTER"><small>Рисунок 6.9 ICMP сообщение,
вернувшееся в нашем примере &quot;порт UDP
недоступен&quot;.</small></p>

<p>&nbsp;</p>

<p><small>Одно из правил, которому подчиняется ICMP,
заключается в том, что ICMP сообщение об ошибке (см.
последнюю колонку на рисунке 6.3) должно включать
IP заголовок (включая все опции) датаграммы, на
которую сгенерирована ошибка. Также ICMP сообщение
об ошибке содержит, по крайней мере, первые 8 байт
из IP датаграммы, которые следуют за IP заголовком.
В нашем примере первые 8 байт, следующие за IP
заголовком, содержат UDP заголовок (рисунок 11.2). </small></p>

<p><small>Очень важный факт заключается в том, что UDP
заголовок содержит номера портов источника и
назначения. В данном случае это порт назначения
(8888), из-за которого было сгенерировано ICMP
сообщение о недоступности порта. Номер порта
источника (2924) может быть использован системой,
получившей ICMP сообщение об ошибке, чтобы
установить соответствие между принятой ошибкой
и конкретным пользовательским процессом (в
данном случае TFTP клиент). </small></p>

<p><small>Одна из причин, по которой IP заголовок
датаграммы, которая вызвала сообщение об ошибке,
посылается обратно, заключается в том, что этот IP
заголовок содержит поле протокола, которое
позволяет ICMP модулю понять, как необходимо
интерпретировать следующие 8 байт (в данном
примере - UDP заголовок). Если обратиться к TCP
заголовку (см. рисунок 17.2), то мы увидим, что
номера портов источника и назначения содержатся
в первых 8 байтах TCP заголовка. Общий формат ICMP
сообщений о недоступности показан на рисунке 6.10. <a NAME="t065001"></a></small></p>


<p ALIGN="CENTER"><small><img SRC="t6_10001.jpg" WIDTH="513" HEIGHT="168"></small></p>


<p ALIGN="CENTER"><small>Рисунок 6.10 Сообщение о
недоступности ICMP.</small></p>

<p>&nbsp;</p>

<p><small>На рисунке 6.3 мы видели, что существует 16
различных ICMP сообщений о недоступности с кодами
от 0 до 15. ICMP сообщение о недоступности порта
имеет код 3. На рисунке 6.10 показано, что второе
32-битное слово в ICMP сообщении должно быть
установлено в 0. Механизм определения
транспортного MTU (глава 2, раздел <a HREF="tcp02.html#t029000">&quot;Транспортный
MTU&quot;</a>) позволяет маршрутизатору поместить MTU
исходящего интерфейса в младшие 16 бит этого
32-битного значения, когда код равен 4 (<a NAME="t065007"></a>&quot;необходима
фрагментация, однако установлен бит не
фрагментировать &quot;). Мы покажем пример подобной
ошибки в разделе <a HREF="tcp11.html#t116000">&quot;ICMP ошибки о
недоступности (требуется фрагментация)&quot;</a>
главы 11. </small></p>

<p>&nbsp;</p>


<p>Правила, по которым
действует ICMP, позволяют системе вернуть больше
чем первые 8 байт раздела данных IP датаграммы,
которая вызвала ICMP ошибку, однако большинство
Berkeley реализаций возвращают ровно 8 байт. В <a NAME="t065008"></a>Solaris 2.2, с использованием опции <a NAME="t065009"></a>ip_icmp_return_data_bytes, может быть указано,
сколько байт необходимо возвращать, однако по
умолчанию возвращаются первые 64 байта данных
(приложение E, раздел <a HREF="tcp_e.html#t354000">&quot;Solaris 2.2&quot;</a>).</p>


<p>&nbsp;</p>
<i><b>

<p><a NAME="t065010"></a>Временная диаграмма работы команды
tcpdump</p>
</b></i>

<p><small>Здесь мы приводим временную диаграмму,
соответствующую выводу команды <a NAME="t065011"></a>tcpdump,
приведенному на рисунке 6.11.<a NAME="t065002"></a></small></p>


<p ALIGN="CENTER"><small><img SRC="t6_11000.jpg" WIDTH="478" HEIGHT="533"></small></p>


<p ALIGN="CENTER"><small>Рисунок 6.11 Временная диаграмма
запроса TFTP на неверный порт.</small></p>

<p>&nbsp;</p>

<p><small>Время на рисунке увеличивается по
направлению вниз, а метки, стоящие крайними слева
на рисунке, соответствуют величинам времени в
выводе команды tcpdump, приведенном на рисунке 6.8.
Метки вверху - это имена хостов и номера портов
каждой конечной системы. Однако, вертикальное
представление времени на рисунке не точно
соответствует реальному времени. При передаче
данных UDP или TCP мы показываем пакет с помощью
жирной линии. </small></p>

<p><small>Почему <a NAME="t065013"></a>TFTP клиент осуществляет <a NAME="t065014"></a>повторную передачу своего запроса
после прихода сообщения ICMP? Особенность сетевого
программирования, присутствующая в системах BSD,
заключается в том, что пользовательский процесс,
использующий UDP, не предупреждается о приеме ICMP
сообщения на этот сокет, если только процесс не
установил соединение (connect) к этому сокету.
Стандартный TFTP клиент системы BSD не выдает connect,
поэтому он никогда не получит уведомления о
приходе ICMP ошибки. </small></p>

<p><small><a NAME="t065015"></a>Также необходимо обратить
внимание на то, что при работе TFTP клиента
используется алгоритм тайм-аутов и повторных
передач. TFTP клиент просто осуществляет повторную
передачу каждые 5 секунд, всего в течение 25
секунд. Позже мы увидим, что подобный алгоритм
протокола TCP значительно лучше.</small></p>

<p>&nbsp;</p>


<p>Устаревший алгоритм
тайм-аутов и повторных передач, используемый TFTP
клиентом, в настоящее время запрещен <a NAME="t065016"></a>Host
Requirements RFC. Тем не менее, все три системы в
описываемой подсети и <a NAME="t065017"></a>Solaris 2.2 до сих
пор его используют. <a NAME="t065018"></a>AIX 3.2.2 использует <a NAME="t065019"></a>экспотенциальный рост тайм-аута,
посылая пакеты с интервалом 0, 5, 15 и 35 секунд. В
настоящее время рекомендуется именно такой
способ расчета тайм-аутов. Более подробно мы
обсудим тайм-ауты в <a HREF="tcp21.html">главе 21</a>.</p>


<p>&nbsp;</p>

<p><small>И в заключение, обратите внимание на то, что
ICMP сообщения вернулись примерно через 3,5
миллисекунды после отправки UDP датаграммы. В <a HREF="tcp07.html">главе 7</a> мы увидим, что это примерно
соответствует времени возврата для отклика Ping.</small></p>
<u><b>

<p><a NAME="t066000"></a>Обработка ICMP сообщений в 4.4BSD</p>
</b></u>

<p><small>Так как ICMP охватывает очень широкий
диапазон различных условий, начиная от фатальных
ошибок и заканчивая информационными
сообщениями, каждое ICMP сообщение обрабатывается
по-своему даже в рамках одной реализации.
Рисунок&nbsp;6.12 это повтор рисунка 6.3, который
показывает обработку возможных ICMP сообщений
системой <a NAME="t066002"></a>4.4BSD. </small></p>

<p><small>Если в последней колонке указано
&quot;ядро&quot;, ICMP сообщение обрабатывается ядром,
если - &quot;пользовательский процесс&quot;, это
означает, что сообщение передается всем
пользовательским процессам, которые
зарегистрированы в ядре так, что могут читать
принятые ICMP сообщения. Если подобных
пользовательских процессов нет, сообщение молча
удаляется. (Эти пользовательские процессы также
получают копии всех других ICMP сообщений, даже
если те обрабатываются ядром, однако только
после того, как ядро обработало сообщение.)
Некоторые сообщения полностью игнорируются. И в
заключение, если в последней колонке находится
строка в кавычках, то эта строка является
сообщением об ошибке Unix, соответствующее
создавшемуся условию. Некоторые из ошибок мы
рассмотрим в следующих главах.<a NAME="t066001"></a></small></p>

<p>&nbsp;</p>


<table BORDER="1" CELLSPACING="1" BORDERCOLOR="#000000" CELLPADDING="5" WIDTH="690">
  <tr>
    <td WIDTH="7%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>тип</small></td>
    <td WIDTH="7%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>код</small></td>
    <td WIDTH="50%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>Описание</small></td>
    <td WIDTH="36%" VALIGN="TOP" BGCOLOR="#ffffff"><p ALIGN="CENTER"><small>Кем
    обрабатывается</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>эхо отклик</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>пользовательский
    процесс</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>3</small></td>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="50%" VALIGN="TOP"><small>назначение
    недоступно - destination unreachable:</small></td>
    <td WIDTH="36%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>сеть недоступна -
    network unreachable</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>хост недоступен -
    host unreachable</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>2</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>протокол
    недоступен - protocol unreachable</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;Connection refused&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>3</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>порт недоступен -
    port unreachable</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;Connection refused&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>4</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>необходима
    фрагментация, но установлен бит DF - fragmentation needed but
    DF bit set </small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;Message too long&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>5</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>сбой маршрутизация
    от источника - source route failed</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>6</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>сеть назначения
    неизвестна - destination network unknown</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>7</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>хост назначения
    неизвестен - destination host unknown</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>8</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>хост назначения
    изолирован - source host isolated (obsolete)</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>9</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>сеть назначения
    административно закрыта - destination network administratively
    prohibited</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>10</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>хост назначения
    административно закрыт - destination host administratively prohibited</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>11</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>сеть недоступна
    для TOS - network unreachable for TOS</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>12</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>хост недоступен
    для TOS - host unreachable for TOS</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;No route to host&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>13</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>связь
    административно закрыта - communication administratively prohibited</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>(игнорируется)</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>14</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>нарушено
    старшинство для хоста - host precedence violation </small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>(игнорируется)</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>15</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>старшинство
    разъединено - precedence cutoff in effect</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>(игнорируется)</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>4</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>подавление
    источника - source quench</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>ядром TCP,
    игнорируется UDP</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>5</small></td>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="50%" VALIGN="TOP"><small>перенаправление -
    redirect:</small></td>
    <td WIDTH="36%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>перенаправление в
    сеть - redirect for network </small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>ядро обновляет
    таблицу маршрутизации</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>перенаправление в
    хост - redirect for host</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>ядро обновляет
    таблицу маршрутизации</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>2</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>перенаправление
    для типа сервиса и сети - redirect for type-of-service and network</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>ядро обновляет
    таблицу маршрутизации</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>3</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>перенаправление
    для типа сервиса и хоста - redirect for type-of-service and host</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>ядро обновляет
    таблицу маршрутизации</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>8</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>эхо запрос - echo request</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>ядро генерирует
    отклик</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>9</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>объявление
    маршрутизатора - router advertisement</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>пользовательский
    процесс</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>10</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>запрос к
    маршрутизатору - router solicitation</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>пользовательский
    процесс</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>11</small></td>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="50%" VALIGN="TOP"><small>время истекло - time
    exceeded: </small></td>
    <td WIDTH="36%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>время жизни стало
    равным 0 в процессе передачи - time-to-live equals 0 during transit</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>пользовательский
    процесс</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>время жизни стало
    равным 0 в процессе повторной сборки - time-to-live equals 0
    during reassembly</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>пользовательский
    процесс</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>12</small></td>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="50%" VALIGN="TOP"><small>проблемы с
    параметрами - parameter problem:</small></td>
    <td WIDTH="36%" VALIGN="TOP">&nbsp;</td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>неверный IP
    заголовок - IP header bad</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;Protocol not available&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP">&nbsp;</td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>1</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>отсутствует
    необходимая опция - required option missing</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>&quot;Protocol not available&quot;</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>13</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>запрос временной
    марки - timestamp request</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>ядро генерирует
    отклик</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>14</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>отклик с временной
    маркой - timestamp reply</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>пользовательский
    процесс</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>15</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>информационный
    запрос - information request </small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>(игнорируется)</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>16</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>информационный
    отклик - information reply </small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>пользовательский
    процесс</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>17</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>запрос маски
    адреса - address mask request</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>ядро генерирует
    отклик</small></td>
  </tr>
  <tr>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>18</small></td>
    <td WIDTH="7%" VALIGN="TOP"><p ALIGN="CENTER"><small>0</small></td>
    <td WIDTH="50%" VALIGN="TOP"><small>отклик с маской
    адреса - address mask reply</small></td>
    <td WIDTH="36%" VALIGN="TOP"><small>пользовательский
    процесс</small></td>
  </tr>
</table>


<p><small>Рисунок 6.12 Обработка ICMP сообщений в <a NAME="t066003"></a>4.4BSD.</small></p>
<u><b>

<p><a NAME="t067000"></a>Краткие выводы</p>
</b></u>

<p><small>В этой главе рассмотрен протокол
управления сообщениями Internet (Internet Control Message Protocol),
который является неотъемлемой частью каждой
реализации. На рисунке 6.3 приведены все типы ICMP
сообщений, большинство из которых мы обсудили
или обсудим в тексте. </small></p>

<p><small>Мы рассмотрели ICMP запрос маски адреса и
соответствующий отклик, а также запрос и отклик
временной марки. Эти типы ICMP сообщений мы
рассмотрели более или менее подробно. Они
являются типичными сообщениями в форме
запрос-отклик. Оба имеют идентификатор и номер
последовательности в ICMP сообщении. Посылающее
приложение сохраняет уникальное значение в поле
идентификатора, чтобы провести различие между
откликами для него самого (направляемые ему) и
откликами для других процессов. Поле номера
последовательности позволяет клиенту
сопоставить запрос с полученным откликом. </small></p>

<p><small><a NAME="t067001"></a>Также мы рассмотрели ICMP ошибку
недоступности порта, которая является наиболее
общей ошибкой ICMP. Это позволило нам более
подробно рассмотреть информацию, которая
возвращается в ICMP ошибке: IP заголовок и следующие
8 байт из IP датаграммы, которая вызвала генерацию
ошибки. Эта информация необходима ICMP модулю,
принимающему ошибку, для того чтобы узнать
больше о том, чем была вызвана ошибка. И TCP, и UDP
сохраняют номера портов источника и назначения в
первых 8 байтах своих заголовков именно по этой
причине. </small></p>

<p><small>В заключение, мы показали строки вывода <a NAME="t067002"></a>tcpdump, эту команду мы будем довольно
часто использовать в следующих главах.</small></p>
<i><b>

<p>Упражнения</b></i> 

<ol>
  <li>В конце раздела <a HREF="#t062000">&quot;Типы
    сообщений ICMP&quot;</a> мы привели 5 специальных
    условий, при которых сообщение об ошибке ICMP не
    посылается. Что произойдет, если эти 5 условий не
    соблюдены, а мы послали широковещательную UDP
    датаграмму на несоответствующий порт в
    локальном кабеле?</li>
  <li>Прочитайте <a NAME="t067003"></a>Host Requirements RFC [<a NAME="t067004"></a>Braden
    1989a], чтобы посмотреть, попадает ли генерация ICMP
    ошибки о недоступности порта под разделы
    &quot;должен&quot;, &quot;следует&quot; или &quot;может&quot;. В
    каком разделе и на какой странице это можно
    найти?</li>
  <li>Прочитайте RFC 1349 [<a NAME="t067005"></a>Almquist 1992], чтобы
    посмотреть, как поле <a NAME="t067006"></a>типа сервиса IP
    (см. рисунок 3.2) должно быть установлено для ICMP.</li>
  <li>Если Ваша система имеет команду <a NAME="t067007"></a>netstat,
    используйте ее, чтобы посмотреть, какой тип ICMP
    сообщений принимается и посылается.</li>
</ol>





<p>&nbsp;</p>
<hr>
</center>
</body>
</html>
